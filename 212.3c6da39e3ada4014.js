"use strict";(self.webpackChunkconserve=self.webpackChunkconserve||[]).push([[212],{3212:(rt,j,d)=>{d.r(j),d.d(j,{AuditsModule:()=>nt});var m=d(4986),g=d(2597),p=d(2197),R=d(7424),q=d(6102),e=d(649);let X=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[m.ez,q.JF,g.u5,p.Gs]]}),i})();var l=d(5121);let B=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[m.ez,l.Bz,p.XC]]}),i})();var C=d(655),_=d(184),x=d(4572),v=d(5547),T=d(9042),S=d(6202);let Z=(()=>{class i{constructor(){}randomIdAndMod(){const t=(new Date).valueOf();return{id:t/1e3|0,mod:t}}randomObjectId(){return(parseInt("local",36)+Math.random()).toString(36)}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),L=(()=>{class i{constructor(t){this.idService=t}findAll(t){const n=[];e:for(let r=0;r<localStorage.length;r++){const o=localStorage.key(r);if(!o||!o.startsWith("audits/")||o.indexOf("/",7)>=0)continue;const a=localStorage.getItem(o);if(!a)continue;const c=JSON.parse(a);if(t)for(const[u,h]of Object.entries(t))if(c[u]!==h)continue e;n.push(c)}return n}findOne(t){const n=localStorage.getItem(`audits/${t}`);if(n)return JSON.parse(n)}getDeltas(t){const n={};for(let r=0;r<localStorage.length;r++){const o=localStorage.key(r);if(!o)continue;const a=new RegExp(`^audits/${t}/delta/(d+)$`).exec(o);if(!a)continue;const[,c]=a,u=localStorage.getItem(o);!u||(n[c]=JSON.parse(u))}return Object.entries(n).sort((r,o)=>+r[0]-+o[0]).map(([,r])=>r)}save(t){this.deleteDeltas(t),localStorage.setItem(`audits/${t.auditId}`,JSON.stringify(t))}create(t){const{id:n,mod:r}=this.idService.randomIdAndMod(),o=(new Date).toISOString(),a=Object.assign(Object.assign({},t),{objectId:this.idService.randomObjectId(),createdAt:o,updatedAt:o,auditId:n.toString(),mod:r.toString(),usn:0,pendingChanges:1});return localStorage.setItem(`audits/${n}`,JSON.stringify(a)),a}update(t,n,r){const o=`audits/${t}`,a=localStorage.getItem(o);if(!a)return!1;const c=JSON.parse(a);if(r(c),c.pendingChanges=(c.pendingChanges||0)+(n?1:0),localStorage.setItem(o,JSON.stringify(c)),n&&!c.objectId.startsWith("local.")){const u=`audits/${c.auditId}/delta/${+new Date}`;localStorage.setItem(u,JSON.stringify(n))}return!0}deleteDeltas(t){this.deleteWithPrefix(`audits/${t.auditId}/delta`),t.pendingChanges=0}delete(t){this.deleteWithPrefix(`audits/${t.auditId}`),delete t.pendingChanges}deleteWithPrefix(t){for(let n=localStorage.length-1;n>=0;n--){const r=localStorage.key(n);r&&r.startsWith(t)&&localStorage.removeItem(r)}}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(Z))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();var O=d(9999);let $=(()=>{class i{constructor(t,n){this.idService=t,this.parseService=n}findAll(t={},n){return n&&!n.includes("auditId")&&n.push("auditId"),this.parseService.findAll("rAudit",t,{keys:n})}create(t){const{id:n,mod:r}=this.idService.randomIdAndMod(),o=Object.assign({auditId:n.toString(),mod:r.toString(),usn:0},t);return this.createFromLocal(o)}createFromLocal(t){return this.parseService.create("rAudit",t)}update(t,n){return this.parseService.update("rAudit",t,n).pipe((0,S.h)(void 0))}updateMany(t,n){return this.parseService.batch(n.map(r=>({method:"PUT",path:`/classes/rAudit/${t}`,body:r}))).pipe((0,S.h)(void 0))}delete(t){return this.parseService.delete("rAudit",t)}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(Z),e.LFG(O.X))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),b=(()=>{class i{constructor(t,n){this.offlineAuditService=t,this.parseAuditService=n}findAll(t={},n){const r=this.offlineAuditService.findAll(t);return this.parseAuditService.findAll(t,n).pipe((0,x.K)(()=>(0,_.of)([])),(0,v.U)(o=>this.mergeAll([...o,...r])))}findOne(t,n){const r=this.offlineAuditService.findOne(t);return this.parseAuditService.findAll({auditId:t},n).pipe((0,x.K)(()=>(0,_.of)([])),(0,v.U)(o=>this.mergeAll(r?[...o,r]:o)),(0,v.U)(o=>o[0]))}mergeAll(t){if(t.length<=1)return t;const n=new Map;for(const r of t){const o=r.auditId,a=n.get(o);if(!a){n.set(o,r);continue}let c;c=a.updatedAt<=r.updatedAt?this.merge(a,r):this.merge(r,a),n.set(o,c)}return[...n.values()]}merge(t,n){return Object.assign(Object.assign(Object.assign({},t),n),{type:Object.assign(Object.assign({},t.type),n.type),zone:Object.assign(Object.assign({},t.zone),n.zone)})}create(t){return this.parseAuditService.create(t).pipe((0,x.K)(()=>(0,_.of)(this.offlineAuditService.create(t))))}update({objectId:t,auditId:n},r,o){return this.offlineAuditService.update(n,r,o)?(0,_.of)(void 0):this.parseAuditService.update(t,r)}upload(t){if(t.objectId.startsWith("local.")){const u=(0,C._T)(t,["objectId","updatedAt","createdAt","pendingChanges"]);return this.parseAuditService.createFromLocal(u).pipe((0,T.b)(h=>this.offlineAuditService.save(h)),(0,S.h)(void 0))}const n=this.offlineAuditService.getDeltas(t.auditId);return this.parseAuditService.updateMany(t.objectId,n).pipe((0,T.b)(()=>this.offlineAuditService.deleteDeltas(t)))}delete({objectId:t}){return this.parseAuditService.delete(t)}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(L),e.LFG($))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),P=(()=>{class i{canDeactivate(t){return t.isSaved()||confirm("Are you sure you want to leave this page? Changes that you made may not be saved.")}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();var f=d(738),k=d(878),W=d(8473),V=d(3333),ee=d(4923),D=d(2797);let Q=(()=>{class i{constructor(t){this.parseService=t}findAll(t={},n){return this.parseService.findAll("rFeature",t,{keys:n})}create(t){return this.parseService.create("rFeature",t)}update(t,n){return this.parseService.update("rFeature",t,n).pipe((0,S.h)(void 0))}updateAll(t,n){return this.parseService.updateAll("rFeature",t,n)}delete(t){return this.parseService.delete("rFeature",t)}deleteAll(t={}){return this.parseService.deleteAll("rFeature",t)}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(O.X))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),H=(()=>{class i{constructor(){}findAll(t){if(t.auditId&&!t.typeId){const a=localStorage.getItem(`audits/${t.auditId}/features/preaudit`);return a?[JSON.parse(a)]:[]}const n=new RegExp(`^audits/${t.auditId||"\\w+"}/features/${t.typeId||"preaudit"}$`),r=[];e:for(let o=0;o<localStorage.length;o++){const a=localStorage.key(o);if(!a||!n.test(a))continue;const c=localStorage.getItem(a);if(!c)continue;const u=JSON.parse(c);for(const[h,y]of Object.entries(t))if(u[h]!==y)continue e;r.push(u)}return r}save(t){const n=this.getKey(t);localStorage.setItem(n,JSON.stringify(t))}update(t,n){const r=this.getKey(t);if(!localStorage.getItem(r))return;const o=Object.assign(Object.assign({},t),n);return localStorage.setItem(r,JSON.stringify(o)),o}getKey(t){return`audits/${t.auditId}/features/${t.typeId||"preaudit"}`}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();const w="\x1f";let A=(()=>{class i{constructor(t,n,r,o,a){this.parseService=t,this.parseFeatureService=n,this.offlineFeatureService=r,this.offlineAuditService=o,this.idService=a}findAll(t={},n){const r=this.offlineFeatureService.findAll(t);return r.length?(0,_.of)(r):this.parseFeatureService.findAll(t,n).pipe((0,x.K)(()=>(0,_.of)(r)))}saveAll(t){this.parseFeatureService.findAll(t).subscribe(n=>{for(const r of n)this.offlineFeatureService.save(r)})}create(t){if(this.offlineAuditService.findOne(t.auditId)){const n=this.idService.randomObjectId(),r=(new Date).toISOString(),o=Object.assign({objectId:n,createdAt:r,updatedAt:r},t);return this.offlineFeatureService.save(o),(0,_.of)(o)}return this.parseFeatureService.create(t)}update(t,n){const r=this.offlineFeatureService.update(t,n);return r?(0,_.of)(r):this.parseFeatureService.update(t.objectId,n).pipe((0,S.h)(Object.assign(Object.assign({},t),n)))}updateAll(t,n){const r=this.offlineFeatureService.findAll(t);if(r.length){for(let o of r)this.offlineFeatureService.update(o,n);return(0,_.of)([])}return this.parseFeatureService.updateAll(t,n)}upload(t){const n=this.offlineFeatureService.findAll(t);return this.parseService.batch(n.map(r=>{const{objectId:o}=r,u=(0,C._T)(r,["objectId","createdAt","updatedAt"]);return o.startsWith("local.")?{path:"/parse/classes/rFeature",method:"POST",body:u}:{path:`/parse/classes/rFeature/${o}`,method:"PUT",body:u}})).pipe((0,v.U)(r=>{for(let o=0;o<r.length;o++){const a=r[o],c=n[o];if("error"in a)continue;const u=a.success;"objectId"in u&&(c.objectId=u.objectId),"createdAt"in u&&(c.createdAt=u.createdAt),"updatedAt"in u&&(c.updatedAt=u.updatedAt),this.offlineFeatureService.save(c)}}))}delete(t){return this.parseFeatureService.delete(t.objectId)}deleteAll(t={}){return this.parseFeatureService.deleteAll(t)}feature2Data(t){const n={},r=t.formId.split(w),o=t.values.split(w),a=Math.min(r.length,o.length);for(let c=0;c<a;c++)n[r[c]]=o[c];return n}data2Feature(t,n){const r=Object.entries(n),o=r.map(([c])=>c),a=o.map(c=>this.findElement(t,c));return{dataType:a.map(c=>{var u;return null!==(u=null==c?void 0:c.dataType)&&void 0!==u?u:""}).join(w),fields:a.map(c=>{var u;return null!==(u=null==c?void 0:c.param)&&void 0!==u?u:""}).join(w),formId:o.join(w),values:r.map(c=>c[1]).join(w)}}findElement(t,n){for(let r of t.geminiForm)for(let o of r.elements)if(o.id===n)return o}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(O.X),e.LFG(Q),e.LFG(H),e.LFG(L),e.LFG(Z))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();var I=d(8496);function ne(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"tr")(1,"td"),e._uU(2),e.qZA(),e.TgZ(3,"td")(4,"input",10),e.NdJ("ngModelChange",function(r){return e.CHM(t).$implicit.read=r}),e.qZA()(),e.TgZ(5,"td")(6,"input",10),e.NdJ("ngModelChange",function(r){return e.CHM(t).$implicit.write=r}),e.qZA()(),e.TgZ(7,"td")(8,"button",11),e.NdJ("click",function(){const o=e.CHM(t).index;return e.oxw().delete(o)}),e._UZ(9,"i",12),e.qZA()()()}if(2&i){const t=s.$implicit,n=e.oxw();e.xp6(2),e.hij(" ",n.userIdToName[t.key]||t.key," "),e.xp6(2),e.Q6J("ngModel",t.read),e.xp6(2),e.Q6J("ngModel",t.write)}}let ie=(()=>{class i{constructor(t,n,r,o,a){this.route=t,this.featureService=n,this.auditService=r,this.parseService=o,this.toastService=a,this.acl=[],this.userIdToName={},this.userNameToId={},this.typeahead=c=>c.pipe(function te(i,s=W.z){return(0,V.e)((t,n)=>{let r=null,o=null,a=null;const c=()=>{if(r){r.unsubscribe(),r=null;const h=o;o=null,n.next(h)}};function u(){const h=a+i,y=s.now();if(y<h)return r=this.schedule(void 0,h-y),void n.add(r);c()}t.subscribe((0,ee.x)(n,h=>{o=h,a=s.now(),r||(r=s.schedule(u,i),n.add(r))},()=>{c(),n.complete()},void 0,()=>{o=r=null}))})}(200),(0,D.x)(),(0,v.U)(u=>{if(u.length<2)return[];const h=u.toLowerCase();return Object.keys(this.userNameToId).filter(y=>y.toLowerCase().includes(h)).slice(0,10)}))}ngOnInit(){this.route.params.pipe((0,f.w)(({aid:t})=>this.auditService.findOne(t,["ACL"]))).subscribe(t=>{var n;this.audit=t,this.acl=Object.entries(null!==(n=null==t?void 0:t.ACL)&&void 0!==n?n:{"*":{read:!0,write:!0}}).map(([r,o])=>Object.assign({key:r},o)).sort(({key:r},{key:o})=>r.localeCompare(o))}),this.parseService.getCurrentUser().subscribe(t=>this.user=t),this.parseService.getUsers().subscribe(t=>{for(let n of t)this.userIdToName[n.objectId]=n.username,this.userNameToId[n.username]=n.objectId})}delete(t){this.acl.splice(t,1)}add(t,n,r){this.acl.push({key:t=this.userNameToId[t]||t,read:n,write:r})}save(){var t,n;const r={};for(let o of this.acl){const{key:a}=o,c=(0,C._T)(o,["key"]);r[a]=c}this.user&&!(null===(t=r[this.user.objectId])||void 0===t?void 0:t.write)&&!(null===(n=r["*"])||void 0===n?void 0:n.write)&&!confirm("The current settings would remove your write access. Are you sure you want to save?")||(0,k.D)([this.auditService.update(this.audit,{ACL:r},o=>o.ACL=r),this.featureService.updateAll({auditId:this.audit.auditId},{ACL:r})]).subscribe(()=>{this.toastService.success("Access Control","Successfully saved access control")},o=>{this.toastService.error("Access Control","Failed to update access control",o)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(l.gz),e.Y36(A),e.Y36(b),e.Y36(O.X),e.Y36(I.kl))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-access-control"]],decls:29,vars:2,consts:[[1,"table","table-sm","table-striped"],[4,"ngFor","ngForOf"],["type","text","placeholder","User Name or ID or role:Rolename or *",1,"form-control",3,"ngbTypeahead"],["keyInput",""],["type","checkbox",1,"form-check-input"],["readCheck",""],["writeCheck",""],["type","button",1,"btn","btn-success",3,"click"],[1,"bi-plus-circle"],[1,"btn","btn-primary",3,"click"],["type","checkbox",1,"form-check-input",3,"ngModel","ngModelChange"],["type","button",1,"btn","btn-danger",3,"click"],[1,"bi-trash"]],template:function(t,n){if(1&t){const r=e.EpF();e.TgZ(0,"table",0)(1,"thead")(2,"tr")(3,"th"),e._uU(4,"User or Role"),e.qZA(),e.TgZ(5,"th"),e._uU(6,"Can Read?"),e.qZA(),e.TgZ(7,"th"),e._uU(8,"Can Write?"),e.qZA(),e.TgZ(9,"th"),e._uU(10,"Actions"),e.qZA()()(),e.TgZ(11,"tbody"),e.YNc(12,ne,10,3,"tr",1),e.qZA(),e.TgZ(13,"tfoot")(14,"tr")(15,"td"),e._UZ(16,"input",2,3),e.qZA(),e.TgZ(18,"td"),e._UZ(19,"input",4,5),e.qZA(),e.TgZ(21,"td"),e._UZ(22,"input",4,6),e.qZA(),e.TgZ(24,"td")(25,"button",7),e.NdJ("click",function(){e.CHM(r);const a=e.MAs(17),c=e.MAs(20),u=e.MAs(23);return n.add(a.value,c.checked,u.checked)}),e._UZ(26,"i",8),e.qZA()()()()(),e.TgZ(27,"button",9),e.NdJ("click",function(){return n.save()}),e._uU(28," Save\n"),e.qZA()}2&t&&(e.xp6(12),e.Q6J("ngForOf",n.acl),e.xp6(4),e.Q6J("ngbTypeahead",n.typeahead))},directives:[m.sg,g.Wl,g.JJ,g.On,p.dR],styles:[""]}),i})();var re=d(4018);let N=(()=>{class i{constructor(t,n){this.http=t,this.parseService=n}loadSchemas(t,n,r){return this.parseService.findAll("Form",{type:t,subtype:n},{keys:r,order:["updatedAt"]}).pipe((0,v.U)(o=>{if(r&&!r.includes("type")&&r.includes("subtype"))return o;const a=new Map(o.map(c=>[c.type+"/"+c.subtype,c]));return Array.from(a.values())}),(0,T.b)(o=>{if(!r)for(let a of o)this.saveLocal(a)}),(0,x.K)(()=>(0,_.of)(this.getAllLocal(t,n))))}loadSchema(t){const{type:n,subtype:r}=t;return this.parseService.findAll("Form",{type:n,subtype:r},{limit:1,order:["-updatedAt"]}).pipe((0,v.U)(o=>{if(0!==o.length){const a=o[0];return this.saveLocal(a),a}}),(0,x.K)(()=>(0,_.of)(this.getLocal(t))))}getAllLocal(t,n){const r=[],o=/^schemas\/([^\/]*)(?:\/([^\/]*))?$/;for(let a=0;a<localStorage.length;a++){const c=localStorage.key(a);if(!c.startsWith("schemas/"))continue;const u=o.exec(c);if(!u)continue;const[,h,y]=u;if("updatedAt"===y||void 0!==t&&h!==t||null===n&&y||void 0!==n&&y!==n)continue;const K=localStorage.getItem(c);if(!K)continue;const it=JSON.parse(K);r.push(it)}return r}getKey({type:t,subtype:n}){return`schemas/${t}${n?"/"+n:""}`}getLocal(t){const n=localStorage.getItem(this.getKey(t));return n?JSON.parse(n):void 0}saveLocal(t){const{updatedAt:n}=t,r=localStorage.getItem(`${this.getKey(t)}/updatedAt`);(!r||r<n)&&(localStorage.setItem(this.getKey(t),JSON.stringify(t)),localStorage.setItem(`${this.getKey(t)}/updatedAt`,n))}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(q.eN),e.LFG(O.X))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})(),oe=(()=>{class i{transform(t){return i.mapping[t]||"text"}}return i.mapping={emailrow:"email",phonerow:"tel",introw:"number",decimalrow:"number"},i.\u0275fac=function(t){return new(t||i)},i.\u0275pipe=e.Yjl({name:"formInputType",type:i,pure:!0}),i})();var U;function se(i,s){if(1&i&&(e.TgZ(0,"option",16),e._uU(1),e.qZA()),2&i){const t=s.$implicit;e.Q6J("value",t.substring(t.indexOf(":")+1)),e.xp6(1),e.hij(" ",t.substring(t.indexOf(":")+1)," ")}}function ae(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"select",14),e.NdJ("ngModelChange",function(r){e.CHM(t);const o=e.oxw().$implicit;return e.oxw(3).data[o.id]=r})("change",function(){return e.CHM(t),e.oxw(4).setDirty()}),e.YNc(1,se,2,2,"option",15),e.qZA()}if(2&i){const t=e.oxw().$implicit,n=e.oxw(2).$implicit,r=e.oxw();e.hYB("id","",n.id,"-",t.id,""),e.Q6J("ngModel",r.data[t.id]),e.uIk("aria-describedby",n.id+"-"+t.id+"-help"),e.xp6(1),e.Q6J("ngForOf",t.defaultValues.split(","))}}function ce(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"textarea",17),e.NdJ("ngModelChange",function(r){e.CHM(t);const o=e.oxw().$implicit;return e.oxw(3).data[o.id]=r})("change",function(){return e.CHM(t),e.oxw(4).setDirty()}),e.qZA()}if(2&i){const t=e.oxw().$implicit,n=e.oxw(2).$implicit,r=e.oxw();e.hYB("id","",n.id,"-",t.id,""),e.Q6J("ngModel",r.data[t.id]),e.uIk("aria-describedby",n.id+"-"+t.id+"-help")}}function ue(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"input",18),e.NdJ("ngModelChange",function(r){e.CHM(t);const o=e.oxw().$implicit;return e.oxw(3).data[o.id]=r})("change",function(){return e.CHM(t),e.oxw(4).setDirty()}),e.ALo(1,"formInputType"),e.qZA()}if(2&i){const t=e.oxw().$implicit,n=e.oxw(2).$implicit,r=e.oxw();e.hYB("id","",n.id,"-",t.id,""),e.Q6J("ngModel",r.data[t.id])("type",e.lcZ(1,5,t.dataType)),e.uIk("aria-describedby",n.id+"-"+t.id+"-help")}}function le(i,s){if(1&i&&(e.TgZ(0,"div",7)(1,"label",8),e._uU(2),e.qZA(),e.ynx(3,9),e.YNc(4,ae,2,5,"select",10),e.YNc(5,ce,1,4,"textarea",11),e.YNc(6,ue,2,7,"input",12),e.BQk(),e.TgZ(7,"div",13),e._uU(8),e.qZA()()),2&i){const t=s.$implicit,n=e.oxw(2).$implicit;e.xp6(1),e.hYB("for","",n.id,"-",t.id,""),e.xp6(1),e.Oqu(t.param),e.xp6(1),e.Q6J("ngSwitch",t.dataType),e.xp6(1),e.Q6J("ngSwitchCase","pickerinputrow"),e.xp6(1),e.Q6J("ngSwitchCase","textarearow"),e.xp6(2),e.hYB("id","",n.id,"-",t.id,"-help"),e.xp6(1),e.Oqu(t.hint)}}function de(i,s){if(1&i&&e.YNc(0,le,9,9,"div",6),2&i){const t=e.oxw().$implicit;e.Q6J("ngForOf",t.elements)}}function pe(i,s){if(1&i&&(e.TgZ(0,"ngb-panel",4),e.YNc(1,de,1,1,"ng-template",5),e.qZA()),2&i){const t=s.$implicit;e.Q6J("id","s-"+t.id)("title",t.section)}}const me=function(){return[]};class F{constructor(s){this.schemaService=s,U.set(this,new re.X(void 0)),this.data={},this.saved=new e.vpe,this.dirty=!1}set schemaId(s){(0,C.Q_)(this,U,"f").next(s)}ngOnInit(){(0,C.Q_)(this,U,"f").pipe((0,D.x)(),(0,f.w)(s=>s?this.schemaService.loadSchema(s):(0,_.of)(void 0))).subscribe(s=>{this.schema=s})}ngOnDestroy(){(0,C.Q_)(this,U,"f").complete()}save(){this.schema&&this.saved.emit([this.schema,this.data]),this.dirty=!1}setDirty(){this.dirty=!0}canDeactivate(){return!this.dirty}}U=new WeakMap,F.\u0275fac=function(s){return new(s||F)(e.Y36(N))},F.\u0275cmp=e.Xpm({type:F,selectors:[["app-form"]],inputs:{schema:"schema",data:"data",schemaId:"schemaId"},outputs:{saved:"saved"},decls:6,vars:3,consts:[[3,"closeOthers"],[3,"id","title",4,"ngFor","ngForOf"],[1,"text-center","text-muted","mt-3","mb-5"],["type","button",1,"btn","btn-primary","btn-lg","btn-floating-action",3,"click"],[3,"id","title"],["ngbPanelContent",""],["class","mb-3",4,"ngFor","ngForOf"],[1,"mb-3"],[1,"form-label",3,"for"],[3,"ngSwitch"],["class","form-select",3,"ngModel","id","ngModelChange","change",4,"ngSwitchCase"],["class","form-control",3,"ngModel","id","ngModelChange","change",4,"ngSwitchCase"],["class","form-control",3,"ngModel","type","id","ngModelChange","change",4,"ngSwitchDefault"],[1,"form-text",3,"id"],[1,"form-select",3,"ngModel","id","ngModelChange","change"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"form-control",3,"ngModel","id","ngModelChange","change"],[1,"form-control",3,"ngModel","type","id","ngModelChange","change"]],template:function(s,t){1&s&&(e.TgZ(0,"ngb-accordion",0),e.YNc(1,pe,2,2,"ngb-panel",1),e.qZA(),e.TgZ(2,"p",2),e._uU(3," Don't forget to save when you're done filling out the form!\n"),e.qZA(),e.TgZ(4,"button",3),e.NdJ("click",function(){return t.save()}),e._uU(5," Save\n"),e.qZA()),2&s&&(e.Q6J("closeOthers",!0),e.xp6(1),e.Q6J("ngForOf",(null==t.schema?null:t.schema.geminiForm)||e.DdM(2,me)))},directives:[p.gY,m.sg,p.Gk,p.gW,m.RF,m.n9,g.EJ,g.JJ,g.On,g.YN,g.Kr,g.Fj,m.ED],pipes:[oe],styles:[""]});const fe=["form"],he=function(){return{type:"Preaudit",subtype:null}};function _e(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"app-form",15,16),e.NdJ("saved",function(r){return e.CHM(t),e.oxw(2).save(r[0],r[1])}),e.qZA()}if(2&i){const t=e.oxw(2);e.Q6J("schemaId",e.DdM(2,he))("data",t.data)}}function ge(i,s){if(1&i&&(e.TgZ(0,"div",0),e.YNc(1,_e,2,3,"app-form",14),e.qZA()),2&i){const t=e.oxw();e.xp6(1),e.Q6J("ngIf",t.data)}}let ve=(()=>{class i{constructor(t,n,r,o){this.auditService=t,this.featureService=n,this.toastService=r,this.route=o}ngOnInit(){this.route.params.pipe((0,f.w)(({aid:t})=>this.auditService.findOne(t,["name","ACL"]))).subscribe(t=>{this.audit=t}),this.route.params.pipe((0,f.w)(({aid:t})=>this.featureService.findAll({auditId:t,belongsTo:"preaudit"}))).subscribe(t=>{this.feature=t[0],this.data=t[0]?this.featureService.feature2Data(t[0]):{}})}isSaved(){var t;return!(null===(t=this.form)||void 0===t?void 0:t.dirty)}save(t,n){if(!this.audit)return;let r;if(this.feature){const o=this.featureService.data2Feature(t,n);r=this.featureService.update(this.feature,o)}else{const o=this.featureService.data2Feature(t,n),{auditId:a,ACL:c}=this.audit;r=this.featureService.create(Object.assign({auditId:a,belongsTo:"preaudit",mod:(new Date).valueOf().toString(),zoneId:null,typeId:null,usn:0,ACL:c},o))}r.subscribe(o=>{this.feature=o,this.toastService.success("Form","Successfully saved form input")},o=>{this.toastService.error("Form","Failed to save form input",o)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(b),e.Y36(A),e.Y36(I.kl),e.Y36(l.gz))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-audit"]],viewQuery:function(t,n){if(1&t&&e.Gf(fe,5),2&t){let r;e.iGM(r=e.CRH())&&(n.form=r.first)}},decls:21,vars:3,consts:[[1,"container"],["routerLink","..",1,"bi-chevron-left","d-lg-none"],["ngbNav","",1,"nav-tabs",3,"activeId"],["nav","ngbNav"],["ngbNavItem","preaudit"],["ngbNavLink","","routerLink","."],["ngbNavContent",""],["ngbNavItem","zones"],["ngbNavLink","","routerLink","zones"],["ngbNavItem","photos"],["ngbNavLink","","routerLink","photos"],["ngbNavItem","access"],["ngbNavLink","","routerLink","access"],[1,"mt-2",3,"ngbNavOutlet"],[3,"schemaId","data","saved",4,"ngIf"],[3,"schemaId","data","saved"],["form",""]],template:function(t,n){if(1&t&&(e.TgZ(0,"div",0)(1,"h1"),e._UZ(2,"a",1),e._uU(3),e.qZA(),e.TgZ(4,"ul",2,3)(6,"li",4)(7,"a",5),e._uU(8,"Preaudit"),e.qZA(),e.YNc(9,ge,2,1,"ng-template",6),e.qZA(),e.TgZ(10,"li",7)(11,"a",8),e._uU(12,"Zone"),e.qZA()(),e.TgZ(13,"li",9)(14,"a",10),e._uU(15,"Photos"),e.qZA()(),e.TgZ(16,"li",11)(17,"a",12),e._uU(18,"Access Control"),e.qZA()()(),e._UZ(19,"router-outlet")(20,"div",13),e.qZA()),2&t){const r=e.MAs(5);let o;e.xp6(3),e.hij(" ",null==n.audit?null:n.audit.name," "),e.xp6(1),e.Q6J("activeId",null!==(o=null==n.route.firstChild||null==n.route.firstChild.routeConfig?null:n.route.firstChild.routeConfig.path)&&void 0!==o?o:"preaudit"),e.xp6(16),e.Q6J("ngbNavOutlet",r)}},directives:[l.yS,p.Pz,p.nv,p.Vx,p.uN,m.O5,F,l.lC,p.tO],styles:[""]}),i})();var be=d(7173),ye=d(1526),Se=d(9964);let Ae=(()=>{class i{constructor(t){this.sanitizer=t}transform(t,n){switch(n){case"html":return this.sanitizer.bypassSecurityTrustHtml(t);case"style":return this.sanitizer.bypassSecurityTrustStyle(t);case"script":return this.sanitizer.bypassSecurityTrustScript(t);case"url":return this.sanitizer.bypassSecurityTrustUrl(t);case"resourceUrl":return this.sanitizer.bypassSecurityTrustResourceUrl(t);default:throw new Error(`Invalid safe type: ${n}`)}}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(Se.H7,16))},i.\u0275pipe=e.Yjl({name:"safe",type:i,pure:!0}),i})();function Ce(i,s){1&i&&(e.TgZ(0,"div",5),e._uU(1," CompanyCam API Key is not configured. Please create or use an "),e.TgZ(2,"a",6),e._uU(3,"access token"),e.qZA(),e._uU(4," and enter it in "),e.TgZ(5,"a",7),e._uU(6,"Settings"),e.qZA(),e._uU(7,".\n"),e.qZA())}function xe(i,s){if(1&i&&(e.TgZ(0,"div",8),e._uU(1," Could not find project on CompanyCam with the same name as the audit "),e.TgZ(2,"b"),e._uU(3),e.qZA(),e._uU(4,". Please check the spelling and wording and rename the audit, or "),e.TgZ(5,"a",9),e._uU(6,"create a project"),e.qZA(),e._uU(7," if not yet done.\n"),e.qZA()),2&i){const t=e.oxw();e.xp6(3),e.Oqu(t.audit.name)}}function Te(i,s){if(1&i&&(e.TgZ(0,"div",10)(1,"a",11),e.ALo(2,"safe"),e._uU(3," Capture Photo "),e.qZA(),e.TgZ(4,"a",12),e.ALo(5,"safe"),e._uU(6," View in App "),e.qZA(),e.TgZ(7,"a",12),e._uU(8," View in Browser "),e.qZA()()),2&i){const t=e.oxw();e.xp6(1),e.Q6J("href",e.xi3(2,3,"ccam://camera/"+t.project.id,"url"),e.LSH),e.xp6(3),e.Q6J("href",e.xi3(5,6,"ccam://projects/"+t.project.id,"url"),e.LSH),e.xp6(3),e.Q6J("href",t.project.project_url,e.LSH)}}function Ze(i,s){if(1&i&&(e.TgZ(0,"li",13)(1,"a",14),e._UZ(2,"img",15),e.qZA(),e.TgZ(3,"h4"),e._uU(4),e.qZA(),e.TgZ(5,"div",16),e._uU(6),e.ALo(7,"date"),e.qZA(),e.TgZ(8,"a",17),e.ALo(9,"safe"),e._uU(10,"Open in App"),e.qZA(),e.TgZ(11,"span",16),e._uU(12," \u2022 "),e.qZA(),e.TgZ(13,"a",14),e._uU(14,"Open in Browser"),e.qZA()()),2&i){const t=s.$implicit;e.xp6(1),e.Q6J("href",t.uris[1].url,e.LSH),e.xp6(1),e.Q6J("src",t.uris[1].url,e.LSH)("alt",t.id),e.xp6(2),e.Oqu(t.creator_name),e.xp6(2),e.hij(" ",e.xi3(7,7,1e3*t.captured_at,"medium")," "),e.xp6(2),e.Q6J("href",e.xi3(9,10,"ccam://photos/"+t.id,"url"),e.LSH),e.xp6(5),e.Q6J("href",t.photo_url,e.LSH)}}let we=(()=>{class i{constructor(t,n,r,o){this.route=t,this.auditService=n,this.companycamService=r,this.companycamCredentialService=o,this.photos=[],this.apiKey=!0}ngOnInit(){this.companycamCredentialService.apiKey?this.route.params.pipe((0,f.w)(({aid:t})=>this.auditService.findOne(t,["name"])),(0,T.b)(t=>this.audit=t),(0,f.w)(t=>t?this.companycamService.getProjects(t.name):(0,_.of)([])),(0,T.b)(t=>this.project=t.length?t[0]:null),(0,f.w)(([t])=>t?this.companycamService.getPhotos(t.id):[])).subscribe(t=>{this.photos=t}):this.apiKey=!1}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(l.gz),e.Y36(b),e.Y36(be.Y),e.Y36(ye.L))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-photos"]],decls:5,vars:4,consts:[["class","alert alert-danger",4,"ngIf"],["class","alert alert-warning",4,"ngIf"],["class","mb-3",4,"ngIf"],[1,"list-group"],["class","list-group-item",4,"ngFor","ngForOf"],[1,"alert","alert-danger"],["href","https://app.companycam.com/access_tokens","target","_blank"],["routerLink","/settings","fragment","companyCamApiKeyInput"],[1,"alert","alert-warning"],["href","https://app.companycam.com/projects/new"],[1,"mb-3"],["target","_blank",1,"btn","btn-primary","me-2",3,"href"],["target","_blank",1,"btn","btn-secondary","me-2",3,"href"],[1,"list-group-item"],["target","_blank",3,"href"],["height","128",1,"float-end",3,"src","alt"],[1,"text-muted"],[3,"href"]],template:function(t,n){1&t&&(e.YNc(0,Ce,8,0,"div",0),e.YNc(1,xe,8,1,"div",1),e.YNc(2,Te,9,9,"div",2),e.TgZ(3,"ul",3),e.YNc(4,Ze,15,13,"li",4),e.qZA()),2&t&&(e.Q6J("ngIf",!n.apiKey),e.xp6(1),e.Q6J("ngIf",n.apiKey&&n.audit&&null===n.project),e.xp6(1),e.Q6J("ngIf",n.project),e.xp6(2),e.Q6J("ngForOf",n.photos))},directives:[m.O5,l.yS,m.sg],pipes:[Ae,m.uU],styles:[""]}),i})();const Ie=[[["","breadcrumb",""]],[["","list",""]]],Fe=function(){return{exact:!0}},Oe=["[breadcrumb]","[list]"];let M=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-master-detail"]],ngContentSelectors:Oe,decls:7,vars:2,consts:[[1,"row","no-gutters","h-100"],["routerLinkActive","master-active",1,"col-lg-3","h-100","overflow-auto","master",3,"routerLinkActiveOptions"],["routerLink",".",1,"d-none"],[1,"col-lg-9","h-100","overflow-auto","detail"]],template:function(t,n){1&t&&(e.F$t(Ie),e.TgZ(0,"div",0)(1,"div",1),e._UZ(2,"a",2),e.Hsn(3),e.Hsn(4,1),e.qZA(),e.TgZ(5,"div",3),e._UZ(6,"router-outlet"),e.qZA()()),2&t&&(e.xp6(1),e.Q6J("routerLinkActiveOptions",e.DdM(1,Fe)))},directives:[l.Od,l.yS,l.lC],styles:["@media (max-width: 991px){.master[_ngcontent-%COMP%]:not(.master-active){display:none!important}.master-active[_ngcontent-%COMP%] + .detail[_ngcontent-%COMP%]{display:none!important}}"]}),i})();const ke=["*"];let z=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-options-dropdown"]],inputs:{id:"id"},ngContentSelectors:ke,decls:5,vars:2,consts:[["ngbDropdown","","placement","bottom-right","container","body",3,"click"],["ngbDropdownToggle","",1,"btn","btn-secondary","btn-sm",3,"id"],["ngbDropdownMenu",""]],template:function(t,n){1&t&&(e.F$t(),e.TgZ(0,"div",0),e.NdJ("click",function(o){return o.stopPropagation(),o.preventDefault()}),e.TgZ(1,"button",1),e._uU(2," Options "),e.qZA(),e.TgZ(3,"div",2),e.Hsn(4),e.qZA()()),2&t&&(e.xp6(1),e.MGl("id","actions-dropdown-",n.id,""),e.xp6(2),e.uIk("aria-labelledby","actions-dropdown-"+n.id))},directives:[p.jt,p.iD,p.Vi],styles:[""]}),i})();function Ue(i,s){1&i&&e._UZ(0,"i",15)}function Le(i,s){}function Ne(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"button",10),e.NdJ("click",function(){e.CHM(t);const r=e.oxw().$implicit;return e.oxw().download(r)}),e._uU(1," Download Offline Copy "),e.qZA(),e._UZ(2,"div",11),e.TgZ(3,"button",16),e.NdJ("click",function(){e.CHM(t);const r=e.oxw().$implicit;return e.oxw().delete(r)}),e._uU(4,"Delete"),e.qZA()}}function Je(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"button",22),e.NdJ("click",function(){e.CHM(t);const r=e.oxw(2).$implicit;return e.oxw().upload(r)}),e._uU(1," Upload "),e.qZA()}}function Me(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"button",16),e.NdJ("click",function(){e.CHM(t);const r=e.oxw(2).$implicit;return e.oxw().download(r)}),e._uU(1," Discard "),e.qZA()}}function ze(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"div",17),e._UZ(1,"i",18),e._uU(2," Pending Changes "),e.TgZ(3,"span",19),e._uU(4),e.qZA()(),e.YNc(5,Je,2,0,"button",20),e.YNc(6,Me,2,0,"button",21),e.TgZ(7,"button",16),e.NdJ("click",function(){e.CHM(t);const r=e.oxw().$implicit;return e.oxw().deleteOffline(r)}),e._uU(8," Remove Offline Copy "),e.qZA()}if(2&i){const t=e.oxw().$implicit;e.xp6(4),e.Oqu(t.pendingChanges),e.xp6(1),e.Q6J("ngIf",t.pendingChanges),e.xp6(1),e.Q6J("ngIf",t.pendingChanges)}}const Ye=function(i){return[i]};function je(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"a",6)(1,"div",7),e._uU(2),e.YNc(3,Ue,1,0,"i",8),e.qZA(),e.TgZ(4,"app-options-dropdown",9)(5,"button",10),e.NdJ("click",function(){const o=e.CHM(t).$implicit;return e.oxw().rename(o)}),e._uU(6,"Rename"),e.qZA(),e._UZ(7,"div",11),e.YNc(8,Le,0,0,"ng-template",12),e.YNc(9,Ne,5,0,"ng-template",null,13,e.W1O),e.YNc(11,ze,9,3,"ng-template",null,14,e.W1O),e.qZA()()}if(2&i){const t=s.$implicit,n=e.MAs(10),r=e.MAs(12);e.Q6J("routerLink",e.VKq(7,Ye,t.auditId)),e.xp6(2),e.hij(" ",t.name," "),e.xp6(1),e.Q6J("ngIf",void 0!==t.pendingChanges),e.xp6(1),e.Q6J("id",t.auditId),e.xp6(4),e.Q6J("ngIf",void 0===t.pendingChanges)("ngIfThen",n)("ngIfElse",r)}}let qe=(()=>{class i{constructor(t,n,r,o,a){this.auditService=t,this.offlineAuditService=n,this.featureService=r,this.schemaService=o,this.toastService=a,this.audits=[]}ngOnInit(){this.auditService.findAll().subscribe(t=>{this.audits=t})}create(){const t=prompt("New Audit Name");!t||this.auditService.create({name:t,type:{},zone:{}}).subscribe(n=>{this.audits.push(n)},n=>{this.toastService.error("Audit","Failed to create audit",n)})}rename(t){const n=prompt("Rename Audit",t.name);!n||this.auditService.update(t,{name:n},r=>r.name=n).subscribe(void 0,r=>{this.toastService.error("Audit","Failed to rename audit",r)})}delete(t){!confirm(`Are you sure you want to delete '${t.name}'?`)||(0,k.D)([this.auditService.delete(t),this.featureService.deleteAll({auditId:t.auditId})]).subscribe(()=>{const n=this.audits.indexOf(t);n>=0&&this.audits.splice(n,1)},n=>{this.toastService.error("Audit","Failed to delete audit",n)})}download(t){t.pendingChanges&&!confirm(`Are you sure you want to discard ${t.pendingChanges} pending changes? This cannot be undone.`)||(this.schemaService.loadSchemas().subscribe(),this.offlineAuditService.save(t),this.featureService.saveAll({auditId:t.auditId}))}upload(t){(0,k.D)([this.auditService.upload(t),this.featureService.upload({auditId:t.auditId})]).subscribe(void 0,n=>{this.toastService.error("Audit","Failed to upload audit",n)})}deleteOffline(t){!confirm("Are you sure you want to discard the offline copy"+(t.pendingChanges?", including "+t.pendingChanges+" pending changes? This cannot be undone.":"? This can be undone once an internet connection is available."))||this.offlineAuditService.delete(t)}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(b),e.Y36(L),e.Y36(A),e.Y36(N),e.Y36(I.kl))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-pre-audit"]],decls:9,vars:1,consts:[["breadcrumb","","aria-label","breadcrumb"],[1,"breadcrumb","p-3","bg-light","bg-darkmode-dark"],["aria-current","page",1,"breadcrumb-item","active"],["list","",1,"list-group","rounded-0"],[1,"list-group-item","list-group-item-action","text-success",3,"click"],["class","list-group-item list-group-item-action d-flex align-items-center","routerLinkActive","active text-white",3,"routerLink",4,"ngFor","ngForOf"],["routerLinkActive","active text-white",1,"list-group-item","list-group-item-action","d-flex","align-items-center",3,"routerLink"],[1,"flex-grow-1"],["class","bi-wifi-off","ngbTooltip","Available Offline",4,"ngIf"],[1,"visible-hover",3,"id"],["ngbDropdownItem","",3,"click"],[1,"dropdown-divider"],[3,"ngIf","ngIfThen","ngIfElse"],["onlineOptions",""],["offlineOptions",""],["ngbTooltip","Available Offline",1,"bi-wifi-off"],["ngbDropdownItem","",1,"text-danger",3,"click"],[1,"dropdown-header"],[1,"bi-wifi-off"],[1,"badge","bg-primary"],["ngbDropdownItem","","class","text-success",3,"click",4,"ngIf"],["ngbDropdownItem","","class","text-danger",3,"click",4,"ngIf"],["ngbDropdownItem","",1,"text-success",3,"click"]],template:function(t,n){1&t&&(e.TgZ(0,"app-master-detail")(1,"nav",0)(2,"ol",1)(3,"li",2),e._uU(4,"Audits"),e.qZA()()(),e.TgZ(5,"div",3)(6,"button",4),e.NdJ("click",function(){return n.create()}),e._uU(7," New Audit "),e.qZA(),e.YNc(8,je,13,9,"a",5),e.qZA()()),2&t&&(e.xp6(8),e.Q6J("ngForOf",n.audits))},directives:[M,m.sg,l.yS,l.Od,m.O5,p._L,z,p.TH],styles:[""]}),i})(),J=(()=>{class i{constructor(t,n){this.idService=t,this.auditService=n}get(t,n){return this.auditService.findOne(t,["zone"]).pipe((0,v.U)(r=>null==r?void 0:r.zone[n]))}getAll(t){return this.auditService.findOne(t,["zone"]).pipe((0,v.U)(n=>n?Object.values(n.zone):[]))}create(t,n){const{id:r,mod:o}=this.idService.randomIdAndMod(),a=Object.assign({id:r,mod:o,usn:0,name:"",typeId:[]},n);return this.auditService.update(t,{[`zone.${r}`]:a},c=>c.zone[r]=a).pipe((0,S.h)(a))}update(t,n,r){const o={};for(const[a,c]of Object.entries(r))o[`zone.${n}.${a}`]=c;return this.auditService.update(t,o,a=>Object.assign(a.zone[n],r))}delete(t,{id:n,typeId:r}){const o={[`zone.${n}`]:{__op:"Delete"}};for(const a of r)o[`type.${a}`]={__op:"Delete"};return this.auditService.update(t,o,a=>{delete a.zone[n];for(const c of r)delete a.type[c]})}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(Z),e.LFG(b))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),Y=(()=>{class i{constructor(t,n){this.idService=t,this.auditService=n}get(t,n,r){return this.auditService.findOne(t,["type"]).pipe((0,v.U)(o=>null==o?void 0:o.type[r]))}getAll(t,n){return this.auditService.findOne(t,["zone","type"]).pipe((0,v.U)(r=>r?r.zone[n].typeId.map(o=>r.type[o]):[]))}create(t,n,r){const{id:o,mod:a}=this.idService.randomIdAndMod(),c=Object.assign({id:o,mod:a,usn:0,zoneId:n},r);return this.auditService.update(t,{[`type.${o}`]:c,[`zone.${n}.typeId`]:{__op:"AddUnique",objects:[o]}},u=>{u.type[o]=c,u.zone[n].typeId.push(o)}).pipe((0,S.h)(c))}update(t,n,r){const o={};for(const[a,c]of Object.entries(r))o[`type.${n}.${a}`]=c;return this.auditService.update(t,o,a=>Object.assign(a.type[n],r))}delete(t,n,r){return this.auditService.update(t,{[`type.${r}`]:{__op:"Delete"},[`zone.${n}.typeId`]:{__op:"Remove",objects:[r]}},o=>{delete o.type[r];const a=o.zone[n],c=a.typeId.indexOf(r);c>=0&&a.typeId.splice(c,1)})}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(Z),e.LFG(b))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();function $e(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"button",4),e.NdJ("click",function(){e.CHM(t);const r=e.oxw();return r.createType(r.type,null)}),e._uU(1),e.qZA()}if(2&i){const t=e.oxw();e.xp6(1),e.hij(" New ",t.type," ")}}function Pe(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"button",7),e.NdJ("click",function(){const o=e.CHM(t).$implicit,a=e.oxw(2);return a.createType(a.type,o)}),e._uU(1),e.qZA()}if(2&i){const t=s.$implicit;e.xp6(1),e.hij(" ",t," ")}}function De(i,s){if(1&i&&(e.TgZ(0,"details",5)(1,"summary"),e._uU(2,"New"),e.qZA(),e.YNc(3,Pe,2,1,"button",6),e.qZA()),2&i){const t=e.oxw();e.xp6(3),e.Q6J("ngForOf",t.subtypes)}}function Qe(i,s){if(1&i){const t=e.EpF();e.ynx(0),e._UZ(1,"div",14),e.TgZ(2,"button",15),e.NdJ("click",function(){e.CHM(t);const r=e.oxw().$implicit;return e.oxw().delete(r)}),e._uU(3,"Delete"),e.qZA(),e.BQk()}}function He(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"a",8)(1,"div",9),e._uU(2),e.TgZ(3,"small",10),e._uU(4),e.qZA()(),e.TgZ(5,"app-options-dropdown",11)(6,"button",12),e.NdJ("click",function(){const o=e.CHM(t).$implicit;return e.oxw().rename(o)}),e._uU(7,"Rename"),e.qZA(),e.YNc(8,Qe,4,0,"ng-container",13),e.qZA()()}if(2&i){const t=s.$implicit,n=e.oxw();e.Q6J("routerLink",""+t.id),e.xp6(2),e.hij(" ",t.name," "),e.xp6(2),e.Oqu(t.subtype),e.xp6(4),e.Q6J("ngIf",n.audit&&void 0===n.audit.pendingChanges)}}let E=(()=>{class i{constructor(t,n,r,o,a,c){this.route=t,this.auditService=n,this.typeService=r,this.featureService=o,this.toastService=a,this.schemaService=c,this.subtypes=[]}ngOnInit(){this.route.params.pipe((0,T.b)(({type:t})=>this.type=t),(0,f.w)(({type:t})=>this.schemaService.loadSchemas(t,void 0,["subtype"]))).subscribe(t=>{this.subtypes=Array.from(new Set(t.filter(n=>n.subtype).map(n=>n.subtype))).sort()}),this.route.params.pipe((0,f.w)(({aid:t,zid:n,type:r})=>this.typeService.getAll(t,+n).pipe((0,v.U)(o=>o.filter(a=>a.type===r))))).subscribe(t=>this.types=t),this.route.params.pipe((0,f.w)(({aid:t})=>this.auditService.findOne(t,[]))).subscribe(t=>{this.audit=t})}createType(t,n){const r=n||t,o=prompt(`New ${r} Name`);!o||this.typeService.create(this.audit,+this.route.snapshot.params.zid,{type:t,subtype:n,name:o}).subscribe(a=>{var c;null===(c=this.types)||void 0===c||c.push(a)},a=>{this.toastService.error(n||t,`Failed to create ${r}`,a)})}rename(t){const n=prompt("Rename Type",t.name);!n||this.typeService.update(this.audit,t.id,{name:n}).subscribe(void 0,r=>{this.toastService.error("Type","Failed to rename type",r)})}delete(t){!confirm(`Are you sure you want to delete '${t.name}'?`)||(0,k.D)([this.typeService.delete(this.audit,t.zoneId,t.id),this.featureService.deleteAll({typeId:t.id.toString()})]).subscribe(()=>{if(!this.types)return;const n=this.types.indexOf(t);n>=0&&this.types.splice(n,1)},n=>{this.toastService.error("Type","Failed to delete type",n)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(l.gz),e.Y36(b),e.Y36(Y),e.Y36(A),e.Y36(I.kl),e.Y36(N))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-type-list"]],decls:4,vars:3,consts:[[1,"list-group","rounded-0"],["class","list-group-item list-group-item-action text-success",3,"click",4,"ngIf"],["class","list-group-item text-success",4,"ngIf"],["class","list-group-item list-group-item-action d-flex align-items-center","routerLinkActive","active text-white",3,"routerLink",4,"ngFor","ngForOf"],[1,"list-group-item","list-group-item-action","text-success",3,"click"],[1,"list-group-item","text-success"],["class","btn btn-sm btn-link link-success",3,"click",4,"ngFor","ngForOf"],[1,"btn","btn-sm","btn-link","link-success",3,"click"],["routerLinkActive","active text-white",1,"list-group-item","list-group-item-action","d-flex","align-items-center",3,"routerLink"],[1,"flex-grow-1"],[1,"text-muted"],[1,"visible-hover"],["ngbDropdownItem","",3,"click"],[4,"ngIf"],[1,"dropdown-divider"],["ngbDropdownItem","",1,"text-danger",3,"click"]],template:function(t,n){1&t&&(e.TgZ(0,"div",0),e.YNc(1,$e,2,1,"button",1),e.YNc(2,De,4,1,"details",2),e.YNc(3,He,9,4,"a",3),e.qZA()),2&t&&(e.xp6(1),e.Q6J("ngIf",!n.subtypes.length),e.xp6(1),e.Q6J("ngIf",n.subtypes.length),e.xp6(1),e.Q6J("ngForOf",n.types))},directives:[m.O5,m.sg,l.yS,l.Od,z,p.TH],styles:[""]}),i})(),Ee=(()=>{class i{constructor(t,n,r){this.route=t,this.auditService=n,this.zoneService=r}ngOnInit(){this.route.params.subscribe(({type:t})=>{this.type=t}),this.route.params.pipe((0,f.w)(({aid:t})=>this.auditService.findOne(t,["name"]))).subscribe(t=>{this.audit=t}),this.route.params.pipe((0,f.w)(({aid:t,zid:n})=>this.zoneService.get(t,+n))).subscribe(t=>{this.zone=t})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(l.gz),e.Y36(b),e.Y36(J))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-pre-type"]],decls:18,vars:3,consts:[["breadcrumb","","aria-label","breadcrumb"],[1,"breadcrumb","p-3","bg-light","bg-darkmode-dark"],[1,"breadcrumb-item"],["routerLink","../../../.."],["routerLink","../../.."],["routerLink","../.."],["routerLink",".."],["aria-current","page",1,"breadcrumb-item","active"],["list",""]],template:function(t,n){1&t&&(e.TgZ(0,"app-master-detail")(1,"nav",0)(2,"ol",1)(3,"li",2)(4,"a",3),e._uU(5,"Audits"),e.qZA()(),e.TgZ(6,"li",2)(7,"a",4),e._uU(8),e.qZA()(),e.TgZ(9,"li",2)(10,"a",5),e._uU(11,"Zones"),e.qZA()(),e.TgZ(12,"li",2)(13,"a",6),e._uU(14),e.qZA()(),e.TgZ(15,"li",7),e._uU(16),e.qZA()()(),e._UZ(17,"app-type-list",8),e.qZA()),2&t&&(e.xp6(8),e.Oqu(null==n.audit?null:n.audit.name),e.xp6(6),e.Oqu(null==n.zone?null:n.zone.name),e.xp6(2),e.Oqu(n.type))},directives:[M,l.yS,E],styles:[""]}),i})();function Ge(i,s){if(1&i){const t=e.EpF();e.ynx(0),e._UZ(1,"div",8),e.TgZ(2,"button",9),e.NdJ("click",function(){e.CHM(t);const r=e.oxw().$implicit;return e.oxw().delete(r)}),e._uU(3,"Delete"),e.qZA(),e.BQk()}}function Ke(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"a",3)(1,"div",4),e._uU(2),e.qZA(),e.TgZ(3,"app-options-dropdown",5)(4,"button",6),e.NdJ("click",function(){const o=e.CHM(t).$implicit;return e.oxw().rename(o)}),e._uU(5,"Rename"),e.qZA(),e.YNc(6,Ge,4,0,"ng-container",7),e.qZA()()}if(2&i){const t=s.$implicit,n=e.oxw();e.Q6J("routerLink",""+t.id),e.xp6(2),e.hij(" ",t.name," "),e.xp6(4),e.Q6J("ngIf",n.audit&&void 0===n.audit.pendingChanges)}}let G=(()=>{class i{constructor(t,n,r,o,a){this.route=t,this.auditService=n,this.zoneService=r,this.featureService=o,this.toastService=a}ngOnInit(){this.route.params.pipe((0,f.w)(({aid:t})=>this.auditService.findOne(t,[]))).subscribe(t=>{this.audit=t}),this.route.params.pipe((0,f.w)(({aid:t})=>this.zoneService.getAll(t))).subscribe(t=>{this.zones=t})}createZone(){const t=prompt("New Zone Name");!t||this.zoneService.create(this.audit,{name:t}).subscribe(n=>{var r;null===(r=this.zones)||void 0===r||r.push(n)},n=>{this.toastService.error("Zone","Failed to create zone",n)})}rename(t){const n=prompt("Rename Zone",t.name);!n||this.zoneService.update(this.audit,t.id,{name:n}).subscribe(()=>{t.name=n},r=>{this.toastService.error("Zone","Failed to rename zone",r)})}delete(t){!confirm(`Are you sure you want to delete '${t.name}'?`)||(0,k.D)([this.zoneService.delete(this.audit,t),this.featureService.deleteAll({zoneId:t.id.toString()})]).subscribe(()=>{if(!this.zones)return;const n=this.zones.indexOf(t);n>=0&&this.zones.splice(n,1)},n=>{this.toastService.error("Zone","Failed to delete zone",n)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(l.gz),e.Y36(b),e.Y36(J),e.Y36(A),e.Y36(I.kl))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-zone-list"]],decls:4,vars:1,consts:[[1,"list-group","rounded-0"],[1,"list-group-item","list-group-item-action","text-success",3,"click"],["class","list-group-item list-group-item-action d-flex align-items-center","routerLinkActive","active",3,"routerLink",4,"ngFor","ngForOf"],["routerLinkActive","active",1,"list-group-item","list-group-item-action","d-flex","align-items-center",3,"routerLink"],[1,"flex-grow-1"],[1,"visible-hover"],["ngbDropdownItem","",3,"click"],[4,"ngIf"],[1,"dropdown-divider"],["ngbDropdownItem","",1,"text-danger",3,"click"]],template:function(t,n){1&t&&(e.TgZ(0,"div",0)(1,"button",1),e.NdJ("click",function(){return n.createZone()}),e._uU(2," New Zone "),e.qZA(),e.YNc(3,Ke,7,3,"a",2),e.qZA()),2&t&&(e.xp6(3),e.Q6J("ngForOf",n.zones))},directives:[m.sg,l.yS,l.Od,z,p.TH,m.O5],styles:[""]}),i})(),Re=(()=>{class i{constructor(t,n){this.route=t,this.auditService=n}ngOnInit(){this.route.params.pipe((0,f.w)(({aid:t})=>this.auditService.findOne(t,["name"]))).subscribe(t=>{this.audit=t})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(l.gz),e.Y36(b))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-pre-zone"]],decls:12,vars:1,consts:[["breadcrumb","","aria-label","breadcrumb"],[1,"breadcrumb","p-3","bg-light","bg-darkmode-dark"],[1,"breadcrumb-item"],["routerLink","../.."],["routerLink",".."],["aria-current","page",1,"breadcrumb-item","active"],["list",""]],template:function(t,n){1&t&&(e.TgZ(0,"app-master-detail")(1,"nav",0)(2,"ol",1)(3,"li",2)(4,"a",3),e._uU(5,"Audits"),e.qZA()(),e.TgZ(6,"li",2)(7,"a",4),e._uU(8),e.qZA()(),e.TgZ(9,"li",5),e._uU(10,"Zones"),e.qZA()()(),e._UZ(11,"app-zone-list",6),e.qZA()),2&t&&(e.xp6(8),e.Oqu(null==n.audit?null:n.audit.name))},directives:[M,l.yS,G],styles:[""]}),i})();const Xe=["form"];function Be(i,s){if(1&i){const t=e.EpF();e.TgZ(0,"app-form",4,5),e.NdJ("saved",function(r){return e.CHM(t),e.oxw().save(r[0],r[1])}),e.qZA()}if(2&i){const t=e.oxw();e.Q6J("data",t.data)("schemaId",t.type)}}let We=(()=>{class i{constructor(t,n,r,o,a){this.typeService=t,this.auditService=n,this.featureService=r,this.toastService=o,this.route=a}ngOnInit(){this.route.params.pipe((0,f.w)(({aid:t,zid:n,tid:r})=>this.typeService.get(t,+n,+r))).subscribe(t=>{this.type=t}),this.route.params.pipe((0,f.w)(({aid:t})=>this.auditService.findOne(t,["ACL"]))).subscribe(t=>{this.audit=t}),this.route.params.pipe((0,f.w)(({aid:t,zid:n,tid:r})=>this.featureService.findAll({belongsTo:"type",auditId:t,zoneId:n,typeId:r}))).subscribe(([t])=>{this.feature=t,this.data=t?this.featureService.feature2Data(this.feature):{}})}isSaved(){var t;return!(null===(t=this.form)||void 0===t?void 0:t.dirty)}save(t,n){if(!this.audit)return;let r;if(this.feature){const o=this.featureService.data2Feature(t,n);r=this.featureService.update(this.feature,o)}else{const o=this.featureService.data2Feature(t,n),{aid:a,zid:c,tid:u}=this.route.snapshot.params,{ACL:h}=this.audit;r=this.featureService.create(Object.assign({auditId:a,zoneId:c,typeId:u,belongsTo:"type",mod:(new Date).valueOf().toString(),usn:0,ACL:h},o))}r.subscribe(o=>{this.feature=o,this.toastService.success("Form","Successfully saved form input")},o=>{this.toastService.error("Form","Failed to save form input",o)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(Y),e.Y36(b),e.Y36(A),e.Y36(I.kl),e.Y36(l.gz))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-type"]],viewQuery:function(t,n){if(1&t&&e.Gf(Xe,5),2&t){let r;e.iGM(r=e.CRH())&&(n.form=r.first)}},decls:7,vars:3,consts:[[1,"container"],["routerLink","..",1,"bi-chevron-left","d-lg-none"],[1,"text-muted","small"],[3,"data","schemaId","saved",4,"ngIf"],[3,"data","schemaId","saved"],["form",""]],template:function(t,n){1&t&&(e.TgZ(0,"div",0)(1,"h1"),e._UZ(2,"a",1),e._uU(3),e.TgZ(4,"span",2),e._uU(5),e.qZA()(),e.YNc(6,Be,2,2,"app-form",3),e.qZA()),2&t&&(e.xp6(3),e.hij(" ",null==n.type?null:n.type.name," "),e.xp6(2),e.hij(" ",null==n.type?null:n.type.subtype," "),e.xp6(1),e.Q6J("ngIf",n.data&&n.type))},directives:[l.yS,m.O5,F],styles:[""]}),i})();function Ve(i,s){if(1&i&&(e.TgZ(0,"li",4)(1,"a",5),e._uU(2),e.qZA()()),2&i){const t=s.$implicit;e.Q6J("ngbNavItem",t),e.xp6(1),e.Q6J("routerLink",t),e.xp6(1),e.Oqu(t)}}const et=[{path:"",component:qe,children:[{path:":aid",component:ve,canDeactivate:[P],children:[{path:"zones",component:G},{path:"photos",component:we},{path:"access",component:ie}]}]},{path:":aid/zones",component:Re,children:[{path:":zid",component:(()=>{class i{constructor(t,n,r){this.zoneService=t,this.schemaService=n,this.route=r}ngOnInit(){this.schemaService.loadSchemas(void 0,void 0,["type"]).subscribe(t=>{this.types=Array.from(new Set(t.map(n=>n.type).filter(n=>"Preaudit"!==n)))}),this.route.params.pipe((0,f.w)(({aid:t,zid:n})=>this.zoneService.get(t,n))).subscribe(t=>{this.zone=t})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(J),e.Y36(N),e.Y36(l.gz))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-zone"]],decls:7,vars:3,consts:[[1,"container"],["routerLink","..",1,"bi-chevron-left","d-lg-none"],["ngbNav","",1,"nav-tabs",3,"activeId"],[3,"ngbNavItem",4,"ngFor","ngForOf"],[3,"ngbNavItem"],["ngbNavLink","",3,"routerLink"]],template:function(t,n){1&t&&(e.TgZ(0,"div",0)(1,"h1"),e._UZ(2,"a",1),e._uU(3),e.qZA(),e.TgZ(4,"ul",2),e.YNc(5,Ve,3,3,"li",3),e.qZA(),e._UZ(6,"router-outlet"),e.qZA()),2&t&&(e.xp6(3),e.hij(" ",null==n.zone?null:n.zone.name," "),e.xp6(1),e.Q6J("activeId",null==n.route.firstChild||null==n.route.firstChild.snapshot||null==n.route.firstChild.snapshot.params?null:n.route.firstChild.snapshot.params.type),e.xp6(1),e.Q6J("ngForOf",n.types))},directives:[l.yS,p.Pz,m.sg,p.nv,p.Vx,l.lC],styles:[""]}),i})(),children:[{path:":type",component:E}]}]},{path:":aid/zones/:zid/:type",component:Ee,children:[{path:":tid",component:We,canDeactivate:[P]}]}];let tt=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[l.Bz.forChild(et)],l.Bz]}),i})(),nt=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({providers:[Z,b,L,$,J,Y,A,H,Q],imports:[[m.ez,B,g.u5,p.Oz,p.XC,tt,p.HK,g.u5,X,p.ZS,R.B]]}),i})()}}]);