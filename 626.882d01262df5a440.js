"use strict";(self.webpackChunkconserve=self.webpackChunkconserve||[]).push([[626],{8626:(Xe,J,l)=>{l.r(J),l.d(J,{AuditsModule:()=>We});var m=l(9012),_=l(3121),d=l(8966),L=l(7130),e=l(3326);let E=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[m.ez,L.JF,_.u5,d.Gs]]}),i})();var p=l(1183);let G=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[m.ez,p.Bz,d.XC]]}),i})();var k=l(655),h=l(1041),I=l(1113),v=l(723),y=l(6618),C=l(1833);let Z=(()=>{class i{constructor(){}randomIdAndMod(){const t=(new Date).valueOf();return{id:t/1e3|0,mod:t}}randomObjectId(){return(parseInt("local",36)+Math.random()).toString(36)}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),w=(()=>{class i{constructor(t){this.idService=t}findAll(t){const n=[];e:for(let o=0;o<localStorage.length;o++){const r=localStorage.key(o);if(!r.startsWith("audits/")||r.indexOf("/","audits/".length)>=0)continue;const s=localStorage.getItem(r),c=JSON.parse(s);if(t)for(const u of Object.keys(t))if(c[u]!==t[u])continue e;n.push(c)}return n}findOne(t){const n=localStorage.getItem(`audits/${t}`);if(n)return JSON.parse(n)}getDeltas(t){const n={};for(let o=0;o<localStorage.length;o++){const r=localStorage.key(o),s=new RegExp(`^audits/${t}/delta/(d+)$`).exec(r);if(!s)continue;const[,c]=s,u=localStorage.getItem(r);n[c]=JSON.parse(u)}return Object.entries(n).sort((o,r)=>+o[0]-+r[0]).map(([,o])=>o)}save(t){this.deleteDeltas(t),localStorage.setItem(`audits/${t.auditId}`,JSON.stringify(t))}create(t){const{id:n,mod:o}=this.idService.randomIdAndMod(),r=(new Date).toISOString(),s=Object.assign(Object.assign({},t),{objectId:this.idService.randomObjectId(),createdAt:r,updatedAt:r,auditId:n.toString(),mod:o.toString(),usn:0,pendingChanges:1});return localStorage.setItem(`audits/${n}`,JSON.stringify(s)),s}update(t,n,o){const r=`audits/${t.auditId}`;if(!localStorage.getItem(r))return;const c=o?o(t):t;if(c.pendingChanges=(c.pendingChanges||0)+(n?1:0),localStorage.setItem(r,JSON.stringify(c)),n&&!c.objectId.startsWith("local.")){const u=`audits/${c.auditId}/delta/${+new Date}`;localStorage.setItem(u,JSON.stringify(n))}return c}deleteDeltas(t){this.deleteWithPrefix(`audits/${t.auditId}/delta`),t.pendingChanges=0}delete(t){this.deleteWithPrefix(`audits/${t.auditId}`),delete t.pendingChanges}deleteWithPrefix(t){for(let n=localStorage.length-1;n>=0;n--){const o=localStorage.key(n);o.startsWith(t)&&localStorage.removeItem(o)}}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(Z))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();var x=l(1986);let M=(()=>{class i{constructor(t,n){this.idService=t,this.parseService=n}findAll(t={}){return this.parseService.findAll("rAudit",t)}create(t){const{id:n,mod:o}=this.idService.randomIdAndMod(),r=Object.assign({auditId:n.toString(),mod:o.toString(),usn:0},t);return this.createFromLocal(r)}createFromLocal(t){return this.parseService.create("rAudit",t)}update(t,n){return this.parseService.update("rAudit",t,n).pipe((0,y.h)(void 0))}updateMany(t,n){return this.parseService.batch(n.map(o=>({method:"PUT",path:`/classes/rAudit/${t}`,body:o}))).pipe((0,y.h)(void 0))}delete({objectId:t}){return this.parseService.delete("rAudit",t)}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(Z),e.LFG(x.X))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),g=(()=>{class i{constructor(t,n){this.offlineAuditService=t,this.parseAuditService=n}findAll(t={}){const n=this.offlineAuditService.findAll(t);return this.parseAuditService.findAll(t).pipe((0,I.K)(()=>(0,h.of)([])),(0,v.U)(o=>this.mergeAll([...o,...n])))}findOne(t){const n=this.offlineAuditService.findOne(t);return this.parseAuditService.findAll({auditId:t}).pipe((0,I.K)(()=>(0,h.of)([])),(0,v.U)(o=>this.mergeAll(n?[...o,n]:o)),(0,v.U)(o=>o[0]))}mergeAll(t){if(t.length<=1)return t;const n=new Map;for(const o of t){const r=o.auditId,s=n.get(r);if(!s){n.set(r,o);continue}let c;c=s.updatedAt<=o.updatedAt?this.merge(s,o):this.merge(o,s),n.set(r,c)}return[...n.values()]}merge(t,n){return Object.assign(Object.assign(Object.assign({},t),n),{type:Object.assign(Object.assign({},t.type),n.type),zone:Object.assign(Object.assign({},t.zone),n.zone)})}create(t){return this.parseAuditService.create(t).pipe((0,I.K)(()=>(0,h.of)(this.offlineAuditService.create(t))))}update(t,n,o){const r=this.offlineAuditService.update(t,n,o);return r?(0,h.of)(r):this.parseAuditService.update(t.objectId,n).pipe((0,y.h)(t),(0,v.U)(o))}upload(t){if(t.objectId.startsWith("local.")){const u=(0,k._T)(t,["objectId","updatedAt","createdAt","pendingChanges"]);return this.parseAuditService.createFromLocal(u).pipe((0,C.b)(f=>this.offlineAuditService.save(f)),(0,y.h)(void 0))}const n=this.offlineAuditService.getDeltas(t.auditId);return this.parseAuditService.updateMany(t.objectId,n).pipe((0,C.b)(()=>this.offlineAuditService.deleteDeltas(t)))}delete(t){return this.parseAuditService.delete(t)}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(w),e.LFG(M))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),U=(()=>{class i{canDeactivate(t){return t.isSaved()||confirm("Are you sure you want to leave this page? Changes that you made may not be saved.")}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})();var A=l(2414),F=l(2987);let Y=(()=>{class i{constructor(t){this.parseService=t}findAll(t={},n){return this.parseService.findAll("rFeature",t,{keys:n})}create(t){return this.parseService.create("rFeature",t)}update(t,n){return this.parseService.update("rFeature",t,n).pipe((0,y.h)(void 0))}updateAll(t,n){return this.parseService.updateAll("rFeature",t,n)}delete(t){return this.parseService.delete("rFeature",t)}deleteAll(t={}){return this.parseService.deleteAll("rFeature",t)}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(x.X))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})(),z=(()=>{class i{constructor(){}findAll(t){if(t.auditId&&!t.typeId){const s=localStorage.getItem(`audits/${t.auditId}/features/preaudit`);return s?[JSON.parse(s)]:[]}const n=new RegExp(`^audits/${t.auditId||"\\w+"}/features/${t.typeId||"preaudit"}$`),o=[];e:for(let r=0;r<localStorage.length;r++){const s=localStorage.key(r);if(!n.test(s))continue;const c=localStorage.getItem(s),u=JSON.parse(c);for(const f of Object.keys(t))if(u[f]!==t[f])continue e;o.push(u)}return o}save(t){const n=this.getKey(t);localStorage.setItem(n,JSON.stringify(t))}update(t,n){const o=this.getKey(t);if(!localStorage.getItem(o))return;const r=Object.assign(Object.assign({},t),n);return localStorage.setItem(o,JSON.stringify(r)),r}getKey(t){return`audits/${t.auditId}/features/${t.typeId||"preaudit"}`}}return i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();const T="\x1f";let b=(()=>{class i{constructor(t,n,o,r,s){this.parseService=t,this.parseFeatureService=n,this.offlineFeatureService=o,this.offlineAuditService=r,this.idService=s}findAll(t={},n){const o=this.offlineFeatureService.findAll(t);return o.length>=0?(0,h.of)(o):this.parseFeatureService.findAll(t,n)}saveAll(t){this.parseFeatureService.findAll(t).subscribe(n=>{for(const o of n)this.offlineFeatureService.save(o)})}create(t){if(this.offlineAuditService.findOne(t.auditId)){const n=this.idService.randomObjectId(),o=(new Date).toISOString(),r=Object.assign({objectId:n,createdAt:o,updatedAt:o},t);return this.offlineFeatureService.save(r),(0,h.of)(r)}return this.parseFeatureService.create(t)}update(t,n){const o=this.offlineFeatureService.update(t,n);return o?(0,h.of)(o):this.parseFeatureService.update(t.objectId,n).pipe((0,y.h)(Object.assign(Object.assign({},t),n)))}updateAll(t,n){const o=this.offlineFeatureService.findAll(t);if(o.length){for(let r of o)this.offlineFeatureService.update(r,n);return(0,h.of)([])}return this.parseFeatureService.updateAll(t,n)}upload(t){const n=this.offlineFeatureService.findAll(t);return this.parseService.batch(n.map(o=>{const{objectId:r}=o,u=(0,k._T)(o,["objectId","createdAt","updatedAt"]);return r.startsWith("local.")?{path:"/classes/rFeature",method:"POST",body:u}:{path:`/classes/rFeature/${r}`,method:"PUT",body:u}})).pipe((0,v.U)(o=>{for(let r=0;r<o.length;r++){const s=o[r],c=n[r];if("error"in s)continue;const u=s.success;"objectId"in u&&(c.objectId=u.objectId),"createdAt"in u&&(c.createdAt=u.createdAt),"updatedAt"in u&&(c.updatedAt=u.updatedAt),this.offlineFeatureService.save(c)}}))}delete(t){return this.parseFeatureService.delete(t.objectId)}deleteAll(t={}){return this.parseFeatureService.deleteAll(t)}feature2Data(t){const n={},o=t.formId.split(T),r=t.values.split(T),s=Math.min(o.length,r.length);for(let c=0;c<s;c++)n[o[c]]=r[c];return n}data2Feature(t,n){const o=Object.entries(n),r=o.map(([c])=>c),s=r.map(c=>this.findElement(t,c));return{dataType:s.map(c=>c.dataType).join(T),fields:s.map(c=>c.param).join(T),formId:r.join(T),values:o.map(c=>c[1]).join(T)}}findElement(t,n){for(let o of t.geminiForm)for(let r of o.elements)if(r.id===n)return r}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(x.X),e.LFG(Y),e.LFG(z),e.LFG(w),e.LFG(Z))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();var S=l(4042);let j=(()=>{class i{constructor(t,n){this.http=t,this.parseService=n}loadSchemas(){return this.parseService.findAll("Form").pipe((0,C.b)(t=>{for(let n of t)this.saveLocal(n)}))}loadSchema(t){return this.parseService.findAll("Form",{name:t},{limit:1,order:["-updatedAt"]}).pipe((0,v.U)(n=>{if(0!==n.length){const o=n[0];return this.saveLocal(o),o}}),(0,I.K)(()=>(0,h.of)(this.getLocal(t))))}getLocal(t){const n=localStorage.getItem(`schemas/${t}`);return n?JSON.parse(n):void 0}saveLocal(t){const{name:n,updatedAt:o}=t,r=localStorage.getItem(`schemas/${n}/updatedAt`);(!r||r<o)&&(localStorage.setItem(`schemas/${n}`,JSON.stringify(t)),localStorage.setItem(`schemas/${n}/updatedAt`,o))}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(L.eN),e.LFG(x.X))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac,providedIn:"root"}),i})(),B=(()=>{class i{transform(t){return i.mapping[t]||"text"}}return i.mapping={emailrow:"email",phonerow:"tel",introw:"number",decimalrow:"number"},i.\u0275fac=function(t){return new(t||i)},i.\u0275pipe=e.Yjl({name:"formInputType",type:i,pure:!0}),i})();function W(i,a){if(1&i&&(e.TgZ(0,"option",15),e._uU(1),e.qZA()),2&i){const t=a.$implicit;e.Q6J("value",t.substring(t.indexOf(":")+1)),e.xp6(1),e.hij(" ",t.substring(t.indexOf(":")+1)," ")}}function X(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"select",13),e.NdJ("ngModelChange",function(o){e.CHM(t);const r=e.oxw().$implicit;return e.oxw(3).data[r.id]=o})("change",function(){return e.CHM(t),e.oxw(4).setDirty()}),e.YNc(1,W,2,2,"option",14),e.qZA()}if(2&i){const t=e.oxw().$implicit,n=e.oxw(2).$implicit,o=e.oxw();e.hYB("id","",n.id,"-",t.id,""),e.Q6J("ngModel",o.data[t.id]),e.uIk("aria-describedby",n.id+"-"+t.id+"-help"),e.xp6(1),e.Q6J("ngForOf",t.defaultValues.split(","))}}function K(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"textarea",13),e.NdJ("ngModelChange",function(o){e.CHM(t);const r=e.oxw().$implicit;return e.oxw(3).data[r.id]=o})("change",function(){return e.CHM(t),e.oxw(4).setDirty()}),e.qZA()}if(2&i){const t=e.oxw().$implicit,n=e.oxw(2).$implicit,o=e.oxw();e.hYB("id","",n.id,"-",t.id,""),e.Q6J("ngModel",o.data[t.id]),e.uIk("aria-describedby",n.id+"-"+t.id+"-help")}}function V(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"input",16),e.NdJ("ngModelChange",function(o){e.CHM(t);const r=e.oxw().$implicit;return e.oxw(3).data[r.id]=o})("change",function(){return e.CHM(t),e.oxw(4).setDirty()}),e.ALo(1,"formInputType"),e.qZA()}if(2&i){const t=e.oxw().$implicit,n=e.oxw(2).$implicit,o=e.oxw();e.hYB("id","",n.id,"-",t.id,""),e.Q6J("ngModel",o.data[t.id])("type",e.lcZ(1,5,t.dataType)),e.uIk("aria-describedby",n.id+"-"+t.id+"-help")}}function ee(i,a){if(1&i&&(e.TgZ(0,"div",7),e.TgZ(1,"label",8),e._uU(2),e.qZA(),e.ynx(3,9),e.YNc(4,X,2,5,"select",10),e.YNc(5,K,1,4,"textarea",10),e.YNc(6,V,2,7,"input",11),e.BQk(),e.TgZ(7,"small",12),e._uU(8),e.qZA(),e.qZA()),2&i){const t=a.$implicit,n=e.oxw(2).$implicit;e.xp6(1),e.hYB("for","",n.id,"-",t.id,""),e.xp6(1),e.Oqu(t.param),e.xp6(1),e.Q6J("ngSwitch",t.dataType),e.xp6(1),e.Q6J("ngSwitchCase","pickerinputrow"),e.xp6(1),e.Q6J("ngSwitchCase","textarearow"),e.xp6(2),e.hYB("id","",n.id,"-",t.id,"-help"),e.xp6(1),e.Oqu(t.hint)}}function te(i,a){if(1&i&&e.YNc(0,ee,9,9,"div",6),2&i){const t=e.oxw().$implicit;e.Q6J("ngForOf",t.elements)}}function ne(i,a){if(1&i&&(e.TgZ(0,"ngb-panel",4),e.YNc(1,te,1,1,"ng-template",5),e.qZA()),2&i){const t=a.$implicit;e.Q6J("id","s-"+t.id)("title",t.section)}}const ie=function(){return[]};let $=(()=>{class i{constructor(t){this.formsService=t,this.data={},this.saved=new e.vpe,this.dirty=!1}ngOnInit(){this.type&&!this.schema&&this.formsService.loadSchema(this.type).subscribe(t=>{this.schema=t})}save(){this.saved.emit([this.schema,this.data]),this.dirty=!1}setDirty(){this.dirty=!0}canDeactivate(){return!this.dirty}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(j))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-form"]],hostBindings:function(t,n){1&t&&e.NdJ("beforeunload",function(){return n.canDeactivate()},!1,e.Jf7)},inputs:{type:"type",schema:"schema",data:"data"},outputs:{saved:"saved"},decls:6,vars:2,consts:[["closeOthers","closeOthers"],["class","form",3,"id","title",4,"ngFor","ngForOf"],[1,"text-center","text-muted","mt-3","mb-5"],["type","button",1,"btn","btn-primary","btn-lg","btn-floating-action",3,"click"],[1,"form",3,"id","title"],["ngbPanelContent",""],["class","form-group",4,"ngFor","ngForOf"],[1,"form-group"],[3,"for"],[3,"ngSwitch"],["class","form-control",3,"ngModel","id","ngModelChange","change",4,"ngSwitchCase"],["class","form-control",3,"ngModel","type","id","ngModelChange","change",4,"ngSwitchDefault"],[1,"form-text","text-muted",3,"id"],[1,"form-control",3,"ngModel","id","ngModelChange","change"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"form-control",3,"ngModel","type","id","ngModelChange","change"]],template:function(t,n){1&t&&(e.TgZ(0,"ngb-accordion",0),e.YNc(1,ne,2,2,"ngb-panel",1),e.qZA(),e.TgZ(2,"p",2),e._uU(3," Don't forget to save when you're done filling out the form!\n"),e.qZA(),e.TgZ(4,"button",3),e.NdJ("click",function(){return n.save()}),e._uU(5," Save\n"),e.qZA()),2&t&&(e.xp6(1),e.Q6J("ngForOf",(null==n.schema?null:n.schema.geminiForm)||e.DdM(1,ie)))},directives:[d.gY,m.sg,d.Gk,d.gW,m.RF,m.n9,m.ED,_.EJ,_.JJ,_.On,_.YN,_.Kr,_.Fj],pipes:[B],styles:[""]}),i})(),D=(()=>{class i{constructor(t,n){this.idService=t,this.auditService=n}create(t,n){const{id:o,mod:r}=this.idService.randomIdAndMod(),s=Object.assign({id:o,mod:r,usn:0,name:"",typeId:[]},n);return this.auditService.update(t,{[`zone.${o}`]:s},c=>(c.zone[o]=s,c)).pipe((0,y.h)(s))}update(t,n,o){const r={};for(const[s,c]of Object.entries(o))r[`zone.${n}.${s}`]=c;return this.auditService.update(t,r,s=>(Object.assign(s.zone[n],o),s))}delete(t,{id:n,typeId:o}){const r={[`zone.${n}`]:{__op:"Delete"}};for(const s of o)r[`type.${s}`]={__op:"Delete"};return this.auditService.update(t,r,s=>{delete s.zone[n];for(const c of o)delete s.type[c];return s})}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(Z),e.LFG(g))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();const oe=["*"];let N=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-options-dropdown"]],inputs:{id:"id"},ngContentSelectors:oe,decls:5,vars:2,consts:[["ngbDropdown","","placement","bottom-right","container","body",3,"click"],["ngbDropdownToggle","",1,"btn","btn-secondary","btn-sm",3,"id"],["ngbDropdownMenu",""]],template:function(t,n){1&t&&(e.F$t(),e.TgZ(0,"div",0),e.NdJ("click",function(r){return r.stopPropagation(),r.preventDefault()}),e.TgZ(1,"button",1),e._uU(2," Options "),e.qZA(),e.TgZ(3,"div",2),e.Hsn(4),e.qZA(),e.qZA()),2&t&&(e.xp6(1),e.MGl("id","actions-dropdown-",n.id,""),e.xp6(2),e.uIk("aria-labelledby","actions-dropdown-"+n.id))},directives:[d.jt,d.iD,d.Vi],styles:[""]}),i})();function re(i,a){if(1&i){const t=e.EpF();e.ynx(0),e._UZ(1,"div",8),e.TgZ(2,"button",9),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit;return e.oxw().delete(o.value)}),e._uU(3,"Delete"),e.qZA(),e.BQk()}}const ae=function(i){return[i]};function se(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"a",3),e.TgZ(1,"div",4),e._uU(2),e.qZA(),e.TgZ(3,"app-options-dropdown",5),e.TgZ(4,"button",6),e.NdJ("click",function(){const r=e.CHM(t).$implicit;return e.oxw().rename(r.value)}),e._uU(5,"Rename"),e.qZA(),e.YNc(6,re,4,0,"ng-container",7),e.qZA(),e.qZA()}if(2&i){const t=a.$implicit,n=e.oxw();e.Q6J("routerLink",e.VKq(4,ae,n.routerPrefix+t.value.id)),e.xp6(2),e.hij(" ",t.value.name," "),e.xp6(1),e.Q6J("id",t.value.id),e.xp6(3),e.Q6J("ngIf",void 0===n.audit.pendingChanges)}}let P=(()=>{class i{constructor(t,n,o,r){this.auditService=t,this.zoneService=n,this.featureService=o,this.toastService=r,this.routerPrefix=""}createZone(){const t=prompt("New Zone Name");!t||this.zoneService.create(this.audit,{name:t}).subscribe(n=>{this.audit.zone[n.id]=n},n=>{this.toastService.error("Zone","Failed to create zone",n)})}rename(t){const n=prompt("Rename Zone",t.name);!n||this.zoneService.update(this.audit,t.id,{name:n}).subscribe(()=>{t.name=n},o=>{this.toastService.error("Zone","Failed to rename zone",o)})}delete(t){!confirm(`Are you sure you want to delete '${t.name}'?`)||(0,A.D)([this.zoneService.delete(this.audit,t),this.featureService.deleteAll({zoneId:t.id.toString()})]).subscribe(void 0,n=>{this.toastService.error("Zone","Failed to delete zone",n)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(g),e.Y36(D),e.Y36(b),e.Y36(S.kl))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-zone-list"]],inputs:{audit:"audit",routerPrefix:"routerPrefix"},decls:5,vars:3,consts:[[1,"list-group","rounded-0"],[1,"list-group-item","list-group-item-action","text-success",3,"click"],["class","list-group-item list-group-item-action d-flex align-items-center","routerLinkActive","active",3,"routerLink",4,"ngFor","ngForOf"],["routerLinkActive","active",1,"list-group-item","list-group-item-action","d-flex","align-items-center",3,"routerLink"],[1,"flex-grow-1"],[1,"visible-hover",3,"id"],["ngbDropdownItem","",3,"click"],[4,"ngIf"],[1,"dropdown-divider"],["ngbDropdownItem","",1,"text-danger",3,"click"]],template:function(t,n){1&t&&(e.TgZ(0,"div",0),e.TgZ(1,"button",1),e.NdJ("click",function(){return n.createZone()}),e._uU(2," New Zone "),e.qZA(),e.YNc(3,se,7,6,"a",2),e.ALo(4,"keyvalue"),e.qZA()),2&t&&(e.xp6(3),e.Q6J("ngForOf",e.lcZ(4,1,n.audit.zone)))},directives:[m.sg,p.yS,p.Od,N,d.TH,m.O5],pipes:[m.Nd],styles:[""]}),i})();var ce=l(6838),ue=l(5057),de=l(4837),pe=l(2892);function me(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"tr"),e.TgZ(1,"td"),e._uU(2),e.qZA(),e.TgZ(3,"td"),e.TgZ(4,"input",10),e.NdJ("ngModelChange",function(o){return e.CHM(t).$implicit.read=o}),e.qZA(),e.qZA(),e.TgZ(5,"td"),e.TgZ(6,"input",10),e.NdJ("ngModelChange",function(o){return e.CHM(t).$implicit.write=o}),e.qZA(),e.qZA(),e.TgZ(7,"td"),e.TgZ(8,"button",11),e.NdJ("click",function(){const r=e.CHM(t).index;return e.oxw().delete(r)}),e._UZ(9,"i",12),e.qZA(),e.qZA(),e.qZA()}if(2&i){const t=a.$implicit,n=e.oxw();e.xp6(2),e.hij(" ",n.userIdToName[t.key]||t.key," "),e.xp6(2),e.Q6J("ngModel",t.read),e.xp6(2),e.Q6J("ngModel",t.write)}}let fe=(()=>{class i{constructor(t,n,o,r){this.featureService=t,this.auditService=n,this.parseService=o,this.toastService=r,this.acl=[],this.userIdToName={},this.userNameToId={},this.typeahead=s=>s.pipe(function(i,a=ce.z){return(0,ue.e)((t,n)=>{let o=null,r=null,s=null;const c=()=>{if(o){o.unsubscribe(),o=null;const f=r;r=null,n.next(f)}};function u(){const f=s+i,R=a.now();if(R<f)return o=this.schedule(void 0,f-R),void n.add(o);c()}t.subscribe(new de.Q(n,f=>{r=f,s=a.now(),o||(o=a.schedule(u,i),n.add(o))},()=>{c(),n.complete()},void 0,()=>{r=o=null}))})}(200),(0,pe.x)(),(0,v.U)(c=>{if(c.length<2)return[];const u=c.toLowerCase();return Object.keys(this.userNameToId).filter(f=>f.toLowerCase().includes(u)).slice(0,10)}))}ngOnInit(){this.parseService.getCurrentUser().subscribe(t=>this.user=t),this.parseService.getUsers().subscribe(t=>{for(let n of t)this.userIdToName[n.objectId]=n.username,this.userNameToId[n.username]=n.objectId})}ngOnChanges(t){var n;t.audit&&(this.acl=Object.entries(null!==(n=this.audit.ACL)&&void 0!==n?n:{"*":{read:!0,write:!0}}).map(([o,r])=>Object.assign({key:o},r)).sort(({key:o},{key:r})=>o.localeCompare(r)))}delete(t){this.acl.splice(t,1)}add(t,n,o){this.acl.push({key:t=this.userNameToId[t]||t,read:n,write:o})}save(){var t,n;const o={};for(let r of this.acl){const{key:s}=r,c=(0,k._T)(r,["key"]);o[s]=c}this.user&&!(null===(t=o[this.user.objectId])||void 0===t?void 0:t.write)&&!(null===(n=o["*"])||void 0===n?void 0:n.write)&&!confirm("The current settings would remove your write access. Are you sure you want to save?")||(0,A.D)([this.auditService.update(this.audit,{ACL:o},r=>(r.ACL=o,r)),this.featureService.updateAll({auditId:this.audit.auditId},{ACL:o})]).subscribe(()=>{this.toastService.success("Access Control","Successfully saved access control")},r=>{this.toastService.error("Access Control","Failed to update access control",r)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(b),e.Y36(g),e.Y36(x.X),e.Y36(S.kl))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-access-control"]],inputs:{audit:"audit"},features:[e.TTD],decls:29,vars:2,consts:[[1,"table","table-sm","table-striped"],[4,"ngFor","ngForOf"],["type","text","placeholder","User Name or ID or role:Rolename or *",1,"form-control",3,"ngbTypeahead"],["keyInput",""],["type","checkbox"],["readCheck",""],["writeCheck",""],["type","button",1,"btn","btn-success",3,"click"],[1,"bi-plus-circle"],[1,"btn","btn-primary",3,"click"],["type","checkbox",3,"ngModel","ngModelChange"],["type","button",1,"btn","btn-danger",3,"click"],[1,"bi-trash"]],template:function(t,n){if(1&t){const o=e.EpF();e.TgZ(0,"table",0),e.TgZ(1,"thead"),e.TgZ(2,"tr"),e.TgZ(3,"th"),e._uU(4,"User or Role"),e.qZA(),e.TgZ(5,"th"),e._uU(6,"Can Read?"),e.qZA(),e.TgZ(7,"th"),e._uU(8,"Can Write?"),e.qZA(),e.TgZ(9,"th"),e._uU(10,"Actions"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(11,"tbody"),e.YNc(12,me,10,3,"tr",1),e.qZA(),e.TgZ(13,"tfoot"),e.TgZ(14,"tr"),e.TgZ(15,"td"),e._UZ(16,"input",2,3),e.qZA(),e.TgZ(18,"td"),e._UZ(19,"input",4,5),e.qZA(),e.TgZ(21,"td"),e._UZ(22,"input",4,6),e.qZA(),e.TgZ(24,"td"),e.TgZ(25,"button",7),e.NdJ("click",function(){e.CHM(o);const s=e.MAs(17),c=e.MAs(20),u=e.MAs(23);return n.add(s.value,c.checked,u.checked)}),e._UZ(26,"i",8),e.qZA(),e.qZA(),e.qZA(),e.qZA(),e.qZA(),e.TgZ(27,"button",9),e.NdJ("click",function(){return n.save()}),e._uU(28," Save\n"),e.qZA()}2&t&&(e.xp6(12),e.Q6J("ngForOf",n.acl),e.xp6(4),e.Q6J("ngbTypeahead",n.typeahead))},directives:[m.sg,d.dR,_.Wl,_.JJ,_.On],styles:[""]}),i})();const _e=["form"];function ge(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"app-form",11,12),e.NdJ("saved",function(o){return e.CHM(t),e.oxw(2).save(o[0],o[1])}),e.qZA()}if(2&i){const t=e.oxw(2);e.Q6J("data",t.data)}}function he(i,a){if(1&i&&(e.TgZ(0,"div",0),e.YNc(1,ge,2,1,"app-form",10),e.qZA()),2&i){const t=e.oxw();e.xp6(1),e.Q6J("ngIf",t.selectedAudit)}}function ve(i,a){if(1&i&&e._UZ(0,"app-zone-list",13),2&i){const t=e.oxw();e.Q6J("audit",t.selectedAudit)}}function ye(i,a){if(1&i&&e._UZ(0,"app-access-control",14),2&i){const t=e.oxw();e.Q6J("audit",t.selectedAudit)}}let Ae=(()=>{class i{constructor(t,n,o,r){this.auditService=t,this.featureService=n,this.toastService=o,this.route=r,this.data={},this.activeTab="preaudit"}ngOnInit(){this.route.params.pipe((0,F.w)(({aid:t})=>(0,A.D)([this.auditService.findOne(t),this.featureService.findAll({auditId:t,belongsTo:"preaudit"})]))).subscribe(([t,n])=>{this.selectedAudit=t,this.feature=n[0],this.data=n[0]?this.featureService.feature2Data(n[0]):{}})}isSaved(){var t;return!(null===(t=this.form)||void 0===t?void 0:t.dirty)}save(t,n){let o;if(this.feature){const r=this.featureService.data2Feature(t,n);o=this.featureService.update(this.feature,r)}else{const r=this.featureService.data2Feature(t,n);o=this.featureService.create(Object.assign({auditId:this.selectedAudit.auditId,belongsTo:"preaudit",mod:(new Date).valueOf().toString(),zoneId:null,typeId:null,usn:0,ACL:this.selectedAudit.ACL},r))}o.subscribe(r=>{this.feature=r,this.toastService.success("Form","Successfully saved form input")},r=>{this.toastService.error("Form","Failed to save form input",r)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(g),e.Y36(b),e.Y36(S.kl),e.Y36(p.gz))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-audit"]],viewQuery:function(t,n){if(1&t&&e.Gf(_e,5),2&t){let o;e.iGM(o=e.CRH())&&(n.form=o.first)}},decls:19,vars:3,consts:[[1,"container"],["routerLink","..",1,"bi-chevron-left","d-lg-none"],["ngbNav","",1,"nav-tabs",3,"activeId","activeIdChange"],["nav","ngbNav"],["ngbNavItem","preaudit"],["ngbNavLink",""],["ngbNavContent",""],["ngbNavItem","zone"],["ngbNavItem","access"],[1,"mt-2",3,"ngbNavOutlet"],["type","preaudit",3,"data","saved",4,"ngIf"],["type","preaudit",3,"data","saved"],["form",""],["routerPrefix","zones/",3,"audit"],[3,"audit"]],template:function(t,n){if(1&t&&(e.TgZ(0,"div",0),e.TgZ(1,"h1"),e._UZ(2,"a",1),e._uU(3),e.qZA(),e.TgZ(4,"ul",2,3),e.NdJ("activeIdChange",function(r){return n.activeTab=r}),e.TgZ(6,"li",4),e.TgZ(7,"a",5),e._uU(8,"Preaudit"),e.qZA(),e.YNc(9,he,2,1,"ng-template",6),e.qZA(),e.TgZ(10,"li",7),e.TgZ(11,"a",5),e._uU(12,"Zone"),e.qZA(),e.YNc(13,ve,1,1,"ng-template",6),e.qZA(),e.TgZ(14,"li",8),e.TgZ(15,"a",5),e._uU(16,"Access Control"),e.qZA(),e.YNc(17,ye,1,1,"ng-template",6),e.qZA(),e.qZA(),e._UZ(18,"div",9),e.qZA()),2&t){const o=e.MAs(5);e.xp6(3),e.hij(" ",null==n.selectedAudit?null:n.selectedAudit.name," "),e.xp6(1),e.Q6J("activeId",n.activeTab),e.xp6(14),e.Q6J("ngbNavOutlet",o)}},directives:[p.yS,d.Pz,d.nv,d.Vx,d.uN,d.tO,m.O5,$,P,fe],styles:[""]}),i})();const be=[[["","breadcrumb",""]],[["","list",""]]],Ze=function(){return{exact:!0}},Te=["[breadcrumb]","[list]"];let q=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-master-detail"]],ngContentSelectors:Te,decls:7,vars:2,consts:[[1,"row","no-gutters","h-100"],["routerLinkActive","master-active",1,"col-lg-3","h-100","overflow-auto","master",3,"routerLinkActiveOptions"],["routerLink",".",1,"d-none"],[1,"col-lg-9","h-100","overflow-auto","detail"]],template:function(t,n){1&t&&(e.F$t(be),e.TgZ(0,"div",0),e.TgZ(1,"div",1),e._UZ(2,"a",2),e.Hsn(3),e.Hsn(4,1),e.qZA(),e.TgZ(5,"div",3),e._UZ(6,"router-outlet"),e.qZA(),e.qZA()),2&t&&(e.xp6(1),e.Q6J("routerLinkActiveOptions",e.DdM(1,Ze)))},directives:[p.Od,p.yS,p.lC],styles:["@media (max-width: 991px){.master[_ngcontent-%COMP%]:not(.master-active){display:none!important}.master-active[_ngcontent-%COMP%] + .detail[_ngcontent-%COMP%]{display:none!important}}"]}),i})();function Se(i,a){1&i&&e._UZ(0,"i",15)}function Ce(i,a){}function xe(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"button",10),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit;return e.oxw().download(o)}),e._uU(1," Download Offline Copy "),e.qZA(),e._UZ(2,"div",11),e.TgZ(3,"button",16),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit;return e.oxw().delete(o)}),e._uU(4,"Delete"),e.qZA()}}function Fe(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"button",22),e.NdJ("click",function(){e.CHM(t);const o=e.oxw(2).$implicit;return e.oxw().upload(o)}),e._uU(1," Upload "),e.qZA()}}function Ie(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"button",16),e.NdJ("click",function(){e.CHM(t);const o=e.oxw(2).$implicit;return e.oxw().download(o)}),e._uU(1," Discard "),e.qZA()}}function we(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"div",17),e._UZ(1,"i",18),e._uU(2," Pending Changes "),e.TgZ(3,"span",19),e._uU(4),e.qZA(),e.qZA(),e.YNc(5,Fe,2,0,"button",20),e.YNc(6,Ie,2,0,"button",21),e.TgZ(7,"button",16),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit;return e.oxw().deleteOffline(o)}),e._uU(8," Remove Offline Copy "),e.qZA()}if(2&i){const t=e.oxw().$implicit;e.xp6(4),e.Oqu(t.pendingChanges),e.xp6(1),e.Q6J("ngIf",t.pendingChanges),e.xp6(1),e.Q6J("ngIf",t.pendingChanges)}}const Oe=function(i){return[i]};function ke(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"a",6),e.TgZ(1,"div",7),e._uU(2),e.YNc(3,Se,1,0,"i",8),e.qZA(),e.TgZ(4,"app-options-dropdown",9),e.TgZ(5,"button",10),e.NdJ("click",function(){const r=e.CHM(t).$implicit;return e.oxw().rename(r)}),e._uU(6,"Rename"),e.qZA(),e._UZ(7,"div",11),e.YNc(8,Ce,0,0,"ng-template",12),e.YNc(9,xe,5,0,"ng-template",null,13,e.W1O),e.YNc(11,we,9,3,"ng-template",null,14,e.W1O),e.qZA(),e.qZA()}if(2&i){const t=a.$implicit,n=e.MAs(10),o=e.MAs(12);e.Q6J("routerLink",e.VKq(7,Oe,t.auditId)),e.xp6(2),e.hij(" ",t.name," "),e.xp6(1),e.Q6J("ngIf",void 0!==t.pendingChanges),e.xp6(1),e.Q6J("id",t.auditId),e.xp6(4),e.Q6J("ngIf",void 0===t.pendingChanges)("ngIfThen",n)("ngIfElse",o)}}let Ne=(()=>{class i{constructor(t,n,o,r,s){this.auditService=t,this.offlineAuditService=n,this.featureService=o,this.formsService=r,this.toastService=s,this.audits=[]}ngOnInit(){this.auditService.findAll().subscribe(t=>{this.audits=t})}create(){const t=prompt("New Audit Name");!t||this.auditService.create({name:t,type:{},zone:{}}).subscribe(n=>{this.audits.push(n)},n=>{this.toastService.error("Audit","Failed to create audit",n)})}rename(t){const n=prompt("Rename Audit",t.name);!n||this.auditService.update(t,{name:n},o=>(o.name=n,o)).subscribe(void 0,o=>{this.toastService.error("Audit","Failed to rename audit",o)})}delete(t){!confirm(`Are you sure you want to delete '${t.name}'?`)||(0,A.D)([this.auditService.delete(t),this.featureService.deleteAll({auditId:t.auditId})]).subscribe(()=>{const n=this.audits.indexOf(t);n>=0&&this.audits.splice(n,1)},n=>{this.toastService.error("Audit","Failed to delete audit",n)})}download(t){t.pendingChanges&&!confirm(`Are you sure you want to discard ${t.pendingChanges} pending changes? This cannot be undone.`)||(this.formsService.loadSchemas().subscribe(),this.offlineAuditService.save(t),this.featureService.saveAll({auditId:t.auditId}))}upload(t){(0,A.D)([this.auditService.upload(t),this.featureService.upload({auditId:t.auditId})]).subscribe(void 0,n=>{this.toastService.error("Audit","Failed to upload audit",n)})}deleteOffline(t){!confirm("Are you sure you want to discard the offline copy"+(t.pendingChanges?", including "+t.pendingChanges+" pending changes? This cannot be undone.":"? This can be undone once an internet connection is available."))||this.offlineAuditService.delete(t)}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(g),e.Y36(w),e.Y36(b),e.Y36(j),e.Y36(S.kl))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-pre-audit"]],decls:9,vars:1,consts:[["breadcrumb","","aria-label","breadcrumb"],[1,"breadcrumb"],["aria-current","page",1,"breadcrumb-item","active"],["list","",1,"list-group","rounded-0"],[1,"list-group-item","list-group-item-action","text-success",3,"click"],["class","list-group-item list-group-item-action d-flex align-items-center","routerLinkActive","active text-white",3,"routerLink",4,"ngFor","ngForOf"],["routerLinkActive","active text-white",1,"list-group-item","list-group-item-action","d-flex","align-items-center",3,"routerLink"],[1,"flex-grow-1"],["class","bi-wifi-off","ngbTooltip","Available Offline",4,"ngIf"],[1,"visible-hover",3,"id"],["ngbDropdownItem","",3,"click"],[1,"dropdown-divider"],[3,"ngIf","ngIfThen","ngIfElse"],["onlineOptions",""],["offlineOptions",""],["ngbTooltip","Available Offline",1,"bi-wifi-off"],["ngbDropdownItem","",1,"text-danger",3,"click"],[1,"dropdown-header"],[1,"bi-wifi-off"],[1,"badge","badge-primary"],["ngbDropdownItem","","class","text-success",3,"click",4,"ngIf"],["ngbDropdownItem","","class","text-danger",3,"click",4,"ngIf"],["ngbDropdownItem","",1,"text-success",3,"click"]],template:function(t,n){1&t&&(e.TgZ(0,"app-master-detail"),e.TgZ(1,"nav",0),e.TgZ(2,"ol",1),e.TgZ(3,"li",2),e._uU(4,"Audits"),e.qZA(),e.qZA(),e.qZA(),e.TgZ(5,"div",3),e.TgZ(6,"button",4),e.NdJ("click",function(){return n.create()}),e._uU(7," New Audit "),e.qZA(),e.YNc(8,ke,13,9,"a",5),e.qZA(),e.qZA()),2&t&&(e.xp6(8),e.Q6J("ngForOf",n.audits))},directives:[q,m.sg,p.yS,p.Od,m.O5,N,d.TH,d._L],styles:[""]}),i})();const O=[{id:"plugload",name:"Plugload",subTypes:[{id:"combination_oven",name:"Combination Oven"},{id:"convection_oven",name:"Convection Oven"},{id:"conveyor_oven",name:"Conveyor Oven"},{id:"fryer",name:"Fryer"},{id:"icemaker",name:"Ice Maker"},{id:"rack_oven",name:"Rack Oven"},{id:"steam_cooker",name:"Steam Cooker"},{id:"griddle",name:"Griddle"},{id:"hot_food_cabinet",name:"Hot Food Cabinet"},{id:"conveyor_broiler",name:"Conveyor Broiler"},{id:"dishwasher",name:"Dish Washer"},{id:"pre_rinse_spray",name:"Pre Rinse Spray"},{id:"sample_appliance",name:"Sample Appliance"}]},{id:"hvac",name:"HVAC"},{id:"hotwater",name:"WaterHeater"},{id:"refrigeration",name:"Refrigeration",subTypes:[{id:"walkin_refrigerator",name:"Walk-In Refrigerator"},{id:"walkin_freezer",name:"Walk-In Freezer"},{id:"refrigerator",name:"Refrigerator"},{id:"freezer",name:"Freezer"},{id:"walkin_coolbot",name:"Walk-In Cooler Box"}]},{id:"lighting",name:"Lighting",subTypes:[{id:"halogen",name:"Halogen"},{id:"cfl",name:"CFL"},{id:"linearfluorescent",name:"Linear Fluorescent"},{id:"incandescent",name:"Incandescent"},{id:"hpsodium",name:"High Pressure Sodium"},{id:"lpsodium",name:"Low Pressure Sodium"}]},{id:"motors",name:"Motors"},{id:"others",name:"Others"}];let Q=(()=>{class i{constructor(t,n){this.idService=t,this.auditService=n}create(t,n,o){const{id:r,mod:s}=this.idService.randomIdAndMod(),c=Object.assign({id:r,mod:s,usn:0,zoneId:n.id},o);return this.auditService.update(t,{[`type.${r}`]:c,[`zone.${n.id}.typeId`]:{__op:"AddUnique",objects:[r]}},u=>(u.type[r]=c,n.typeId.push(r),u)).pipe((0,y.h)(c))}update(t,n,o){const r={};for(const[s,c]of Object.entries(o))r[`type.${n}.${s}`]=c;return this.auditService.update(t,r,s=>(Object.assign(s.type[n],o),s))}delete(t,n,o){return this.auditService.update(t,{[`type.${o}`]:{__op:"Delete"},[`zone.${n}.typeId`]:{__op:"Remove",objects:[o]}},r=>{delete r.type[o];const s=r.zone[n],c=s.typeId.indexOf(o);return c>=0&&s.typeId.splice(c,1),r})}}return i.\u0275fac=function(t){return new(t||i)(e.LFG(Z),e.LFG(g))},i.\u0275prov=e.Yz7({token:i,factory:i.\u0275fac}),i})();function qe(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"button",4),e.NdJ("click",function(){e.CHM(t);const o=e.oxw();return o.createType(o.type)}),e._uU(1),e.qZA()}if(2&i){const t=e.oxw();e.xp6(1),e.hij(" New ",t.type.name," ")}}function Je(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"button",7),e.NdJ("click",function(){const r=e.CHM(t).$implicit,s=e.oxw(2);return s.createType(s.type,r)}),e._uU(1),e.qZA()}if(2&i){const t=a.$implicit;e.xp6(1),e.hij(" ",t.name," ")}}function Le(i,a){if(1&i&&(e.TgZ(0,"details",5),e.TgZ(1,"summary"),e._uU(2,"New"),e.qZA(),e.YNc(3,Je,2,1,"button",6),e.qZA()),2&i){const t=e.oxw();e.xp6(3),e.Q6J("ngForOf",t.type.subTypes)}}function Me(i,a){if(1&i){const t=e.EpF();e.ynx(0),e._UZ(1,"div",14),e.TgZ(2,"button",15),e.NdJ("click",function(){e.CHM(t);const o=e.oxw().$implicit;return e.oxw().delete(o)}),e._uU(3,"Delete"),e.qZA(),e.BQk()}}const Ue=function(i){return[i]};function Ye(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"a",8),e.TgZ(1,"div",9),e._uU(2),e.TgZ(3,"small",10),e._uU(4),e.qZA(),e.qZA(),e.TgZ(5,"app-options-dropdown",11),e.TgZ(6,"button",12),e.NdJ("click",function(){const r=e.CHM(t).$implicit;return e.oxw().rename(r)}),e._uU(7,"Rename"),e.qZA(),e.YNc(8,Me,4,0,"ng-container",13),e.qZA(),e.qZA()}if(2&i){const t=a.$implicit,n=e.oxw();e.Q6J("routerLink",e.VKq(5,Ue,n.routerPrefix+t.id)),e.xp6(2),e.hij(" ",t.name," "),e.xp6(2),e.Oqu(t.subtype),e.xp6(1),e.Q6J("id",t.id),e.xp6(3),e.Q6J("ngIf",void 0===n.audit.pendingChanges)}}let H=(()=>{class i{constructor(t,n,o,r){this.auditService=t,this.typeService=n,this.featureService=o,this.toastService=r,this.routerPrefix=""}createType(t,n){var o,r;const s=null!==(o=null==n?void 0:n.name)&&void 0!==o?o:t.name,c=prompt(`New ${s} Name`);!c||this.typeService.create(this.audit,this.zone,{type:t.name,subtype:null!==(r=null==n?void 0:n.name)&&void 0!==r?r:null,name:c}).subscribe(u=>{this.types.push(u)},u=>{this.toastService.error(s,`Failed to create ${s}`,u)})}rename(t){const n=prompt("Rename Type",t.name);!n||this.typeService.update(this.audit,t.id,{name:n}).subscribe(void 0,o=>{this.toastService.error("Type","Failed to rename type",o)})}delete(t){!confirm(`Are you sure you want to delete '${t.name}'?`)||(0,A.D)([this.typeService.delete(this.audit,t.zoneId,t.id),this.featureService.deleteAll({typeId:t.id.toString()})]).subscribe(()=>{const n=this.types.indexOf(t);n>=0&&this.types.splice(n,1)},n=>{this.toastService.error("Type","Failed to delete type",n)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(g),e.Y36(Q),e.Y36(b),e.Y36(S.kl))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-type-list"]],inputs:{audit:"audit",zone:"zone",types:"types",type:"type",routerPrefix:"routerPrefix"},decls:4,vars:3,consts:[[1,"list-group","rounded-0"],["class","list-group-item list-group-item-action text-success",3,"click",4,"ngIf"],["class","list-group-item text-success",4,"ngIf"],["class","list-group-item list-group-item-action d-flex align-items-center","routerLinkActive","active text-white",3,"routerLink",4,"ngFor","ngForOf"],[1,"list-group-item","list-group-item-action","text-success",3,"click"],[1,"list-group-item","text-success"],["class","btn btn-sm btn-link text-success",3,"click",4,"ngFor","ngForOf"],[1,"btn","btn-sm","btn-link","text-success",3,"click"],["routerLinkActive","active text-white",1,"list-group-item","list-group-item-action","d-flex","align-items-center",3,"routerLink"],[1,"flex-grow-1"],[1,"text-muted"],[1,"visible-hover",3,"id"],["ngbDropdownItem","",3,"click"],[4,"ngIf"],[1,"dropdown-divider"],["ngbDropdownItem","",1,"text-danger",3,"click"]],template:function(t,n){1&t&&(e.TgZ(0,"div",0),e.YNc(1,qe,2,1,"button",1),e.YNc(2,Le,4,1,"details",2),e.YNc(3,Ye,9,7,"a",3),e.qZA()),2&t&&(e.xp6(1),e.Q6J("ngIf",!n.type.subTypes),e.xp6(1),e.Q6J("ngIf",n.type.subTypes),e.xp6(1),e.Q6J("ngForOf",n.types))},directives:[m.O5,m.sg,p.yS,p.Od,N,d.TH],styles:[""]}),i})();function ze(i,a){if(1&i&&e._UZ(0,"app-type-list",9),2&i){const t=e.oxw();e.Q6J("audit",t.audit)("zone",t.zone)("types",t.types)("type",t.type)}}let je=(()=>{class i{constructor(t,n){this.route=t,this.auditService=n,this.types=[]}ngOnInit(){this.route.params.pipe((0,F.w)(({aid:t,zid:n,type:o})=>this.auditService.findOne(t).pipe((0,C.b)(r=>{this.type=O.find(s=>s.name===o),this.audit=r,this.zone=r.zone[n],this.types=Object.values(r.type).filter(s=>s.type===o&&s.zoneId==n)})))).subscribe()}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(p.gz),e.Y36(g))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-pre-type"]],decls:18,vars:4,consts:[["breadcrumb","","aria-label","breadcrumb"],[1,"breadcrumb"],[1,"breadcrumb-item"],["routerLink","../../../.."],["routerLink","../../.."],["routerLink","../.."],["routerLink",".."],["aria-current","page",1,"breadcrumb-item","active"],["list","",3,"audit","zone","types","type",4,"ngIf"],["list","",3,"audit","zone","types","type"]],template:function(t,n){1&t&&(e.TgZ(0,"app-master-detail"),e.TgZ(1,"nav",0),e.TgZ(2,"ol",1),e.TgZ(3,"li",2),e.TgZ(4,"a",3),e._uU(5,"Audits"),e.qZA(),e.qZA(),e.TgZ(6,"li",2),e.TgZ(7,"a",4),e._uU(8),e.qZA(),e.qZA(),e.TgZ(9,"li",2),e.TgZ(10,"a",5),e._uU(11,"Zones"),e.qZA(),e.qZA(),e.TgZ(12,"li",2),e.TgZ(13,"a",6),e._uU(14),e.qZA(),e.qZA(),e.TgZ(15,"li",7),e._uU(16),e.qZA(),e.qZA(),e.qZA(),e.YNc(17,ze,1,4,"app-type-list",8),e.qZA()),2&t&&(e.xp6(8),e.Oqu(null==n.audit?null:n.audit.name),e.xp6(6),e.Oqu(null==n.zone?null:n.zone.name),e.xp6(2),e.Oqu(null==n.type?null:n.type.name),e.xp6(1),e.Q6J("ngIf",n.type&&n.audit&&n.zone&&n.types))},directives:[q,p.yS,m.O5,H],styles:[""]}),i})();function $e(i,a){if(1&i&&e._UZ(0,"app-zone-list",7),2&i){const t=e.oxw();e.Q6J("audit",t.audit)}}let De=(()=>{class i{constructor(t,n){this.route=t,this.auditService=n}ngOnInit(){this.route.params.pipe((0,F.w)(({aid:t})=>this.auditService.findOne(t))).subscribe(t=>{this.audit=t})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(p.gz),e.Y36(g))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-pre-zone"]],decls:12,vars:2,consts:[["breadcrumb","","aria-label","breadcrumb"],[1,"breadcrumb"],[1,"breadcrumb-item"],["routerLink","../.."],["routerLink",".."],["aria-current","page",1,"breadcrumb-item","active"],["list","",3,"audit",4,"ngIf"],["list","",3,"audit"]],template:function(t,n){1&t&&(e.TgZ(0,"app-master-detail"),e.TgZ(1,"nav",0),e.TgZ(2,"ol",1),e.TgZ(3,"li",2),e.TgZ(4,"a",3),e._uU(5,"Audits"),e.qZA(),e.qZA(),e.TgZ(6,"li",2),e.TgZ(7,"a",4),e._uU(8),e.qZA(),e.qZA(),e.TgZ(9,"li",5),e._uU(10,"Zones"),e.qZA(),e.qZA(),e.qZA(),e.YNc(11,$e,1,1,"app-zone-list",6),e.qZA()),2&t&&(e.xp6(8),e.Oqu(null==n.audit?null:n.audit.name),e.xp6(3),e.Q6J("ngIf",n.audit))},directives:[q,p.yS,m.O5,P],styles:[""]}),i})();const Pe=["form"];function Qe(i,a){if(1&i){const t=e.EpF();e.TgZ(0,"app-form",4,5),e.NdJ("saved",function(){e.CHM(t);const o=e.oxw();return o.save(o.data)}),e.qZA()}if(2&i){const t=e.oxw();e.Q6J("data",t.data)("type",t.schemaId)}}let He=(()=>{class i{constructor(t,n,o,r){this.auditService=t,this.featureService=n,this.toastService=o,this.route=r}ngOnInit(){this.route.params.pipe((0,F.w)(({aid:t,zid:n,tid:o})=>(0,A.D)([(0,h.of)(o),this.auditService.findOne(t),this.featureService.findAll({auditId:t,zoneId:n,typeId:o})]))).subscribe(([t,n,o])=>{this.audit=n,this.type=n.type[t];const r=O.find(c=>c.name===this.type.type),s=this.type.subtype?r.subTypes.find(c=>c.name===this.type.subtype):r;this.schemaId=s.id,this.feature=o[0],this.data=this.feature?this.featureService.feature2Data(this.feature):{}})}isSaved(){var t;return!(null===(t=this.form)||void 0===t?void 0:t.dirty)}save(t,n){let o;if(this.feature){const r=this.featureService.data2Feature(t,n);o=this.featureService.update(this.feature,r)}else{const r=this.featureService.data2Feature(t,n),{aid:s,zid:c,tid:u}=this.route.snapshot.params;o=this.featureService.create(Object.assign({auditId:s,zoneId:c,typeId:u,belongsTo:"type",mod:(new Date).valueOf().toString(),usn:0,ACL:this.audit.ACL},r))}o.subscribe(r=>{this.feature=r,this.toastService.success("Form","Successfully saved form input")},r=>{this.toastService.error("Form","Failed to save form input",r)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(g),e.Y36(b),e.Y36(S.kl),e.Y36(p.gz))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-type"]],viewQuery:function(t,n){if(1&t&&e.Gf(Pe,5),2&t){let o;e.iGM(o=e.CRH())&&(n.form=o.first)}},decls:7,vars:3,consts:[[1,"container"],["routerLink","..",1,"bi-chevron-left","d-lg-none"],[1,"text-muted","small"],[3,"data","type","saved",4,"ngIf"],[3,"data","type","saved"],["form",""]],template:function(t,n){1&t&&(e.TgZ(0,"div",0),e.TgZ(1,"h1"),e._UZ(2,"a",1),e._uU(3),e.TgZ(4,"span",2),e._uU(5),e.qZA(),e.qZA(),e.YNc(6,Qe,2,2,"app-form",3),e.qZA()),2&t&&(e.xp6(3),e.hij(" ",null==n.type?null:n.type.name," "),e.xp6(2),e.hij(" ",null==n.type?null:n.type.subtype," "),e.xp6(1),e.Q6J("ngIf",n.data))},directives:[p.yS,m.O5,$],styles:[""]}),i})();function Re(i,a){if(1&i&&e._UZ(0,"app-type-list",9),2&i){const t=e.oxw().$implicit,n=e.oxw();e.Q6J("types",n.groupedTypes[t.name])("audit",n.audit)("zone",n.selectedZone)("type",t)("routerPrefix",t.name+"/")}}function Ee(i,a){if(1&i&&(e.TgZ(0,"li",6),e.TgZ(1,"a",7),e._uU(2),e.qZA(),e.YNc(3,Re,1,5,"ng-template",8),e.qZA()),2&i){const t=a.$implicit;e.Q6J("ngbNavItem",t.name),e.xp6(2),e.Oqu(t.name)}}const Ge=[{path:"",component:Ne,children:[{path:":aid",component:Ae,canDeactivate:[U]}]},{path:":aid/zones",component:De,children:[{path:":zid",component:(()=>{class i{constructor(t,n){this.auditService=t,this.route=n,this.types=O,this.groupedTypes={}}ngOnInit(){this.route.params.pipe((0,F.w)(({aid:t,zid:n})=>this.auditService.findOne(t).pipe((0,C.b)(o=>this.audit=o),(0,v.U)(o=>o.zone[n])))).subscribe(t=>{var n,o;this.selectedZone=t;const r=null!==(o=null===(n=this.selectedZone)||void 0===n?void 0:n.typeId.map(s=>this.audit.type[s]))&&void 0!==o?o:[];for(const s of O)this.groupedTypes[s.name]=[];for(const s of r)this.groupedTypes[s.type].push(s)})}}return i.\u0275fac=function(t){return new(t||i)(e.Y36(g),e.Y36(p.gz))},i.\u0275cmp=e.Xpm({type:i,selectors:[["app-zone"]],decls:8,vars:4,consts:[[1,"container"],["routerLink","..",1,"bi-chevron-left","d-lg-none"],["ngbNav","",1,"nav-tabs",3,"activeId","activeIdChange"],["nav","ngbNav"],[3,"ngbNavItem",4,"ngFor","ngForOf"],[1,"mt-2",3,"ngbNavOutlet"],[3,"ngbNavItem"],["ngbNavLink",""],["ngbNavContent",""],[3,"types","audit","zone","type","routerPrefix"]],template:function(t,n){if(1&t&&(e.TgZ(0,"div",0),e.TgZ(1,"h1"),e._UZ(2,"a",1),e._uU(3),e.qZA(),e.TgZ(4,"ul",2,3),e.NdJ("activeIdChange",function(r){return n.activeTab=r}),e.YNc(6,Ee,4,2,"li",4),e.qZA(),e._UZ(7,"div",5),e.qZA()),2&t){const o=e.MAs(5);e.xp6(3),e.hij(" ",null==n.selectedZone?null:n.selectedZone.name," "),e.xp6(1),e.Q6J("activeId",n.activeTab),e.xp6(2),e.Q6J("ngForOf",n.types),e.xp6(1),e.Q6J("ngbNavOutlet",o)}},directives:[p.yS,d.Pz,m.sg,d.tO,d.nv,d.Vx,d.uN,H],styles:[""]}),i})()}]},{path:":aid/zones/:zid/:type",component:je,children:[{path:":tid",component:He,canDeactivate:[U]}]}];let Be=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({imports:[[p.Bz.forChild(Ge)],p.Bz]}),i})(),We=(()=>{class i{}return i.\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.oAB({type:i}),i.\u0275inj=e.cJS({providers:[Z,g,w,M,D,Q,b,z,Y],imports:[[m.ez,G,_.u5,d.Oz,d.XC,Be,d.HK,_.u5,E,d.ZS]]}),i})()}}]);